<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BetSpread – App</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--bg:#0b1324;--card:#0d1528;--muted:#9fb0c9;--text:#e5e7eb;--accent:#22c55e;--danger:#ef4444;--line:#1f2c49}
    *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{position:sticky;top:0;z-index:50;background:var(--bg);border-bottom:1px solid var(--line)}
    .bar{max-width:1100px;margin:0 auto;display:flex;gap:12px;align-items:center;padding:14px 16px}
    .logo{font-weight:800;font-size:20px;letter-spacing:.2px}
    .chip{font-size:12px;padding:2px 8px;border:1px solid #2a3955;border-radius:999px;color:#b8c3d6}
    .grow{flex:1}
    .btn{background:#1f2937;border:1px solid #2a3955;color:#dbe3f2;border-radius:8px;padding:10px 14px;cursor:pointer}
    .btn:hover{background:#233146}
    .btn-green{background:#16a34a;border-color:#16a34a;color:white}
    .btn-green:hover{background:#149244}
    .btn-danger{background:#7f1d1d;border-color:#7f1d1d}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:linear-gradient(180deg,#0d1528,#0a1020);border:1px solid var(--line);border-radius:14px;padding:16px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .field{display:flex;flex-direction:column;gap:6px;min-width:160px;flex:1}
    .field input,.field select,.field textarea{background:#0d1524;border:1px solid var(--line);border-radius:10px;padding:10px 12px;color:#e7eefc}
    .tabs{display:flex;gap:8px;margin:14px 0}
    .tab{padding:10px 14px;border:1px solid #243142;border-bottom:0;border-top-left-radius:8px;border-top-right-radius:8px;background:#0d1528;cursor:pointer}
    .tab.active{background:#12203d;font-weight:600}
    .panel{display:none;border:1px solid #243142;border-radius:0 10px 10px 10px;padding:16px;background:#0d1528}
    .panel.active{display:block}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px;border-bottom:1px solid #1d2a44;text-align:left;font-size:14px}
    .banner{background:#3b0d0d;border:1px solid #5f1a1a;color:#ffd2d2;border-radius:10px;padding:10px 12px;margin:12px 0}
    .kpi{display:flex;gap:14px;flex-wrap:wrap}
    .kpi .box{background:#0d1528;border:1px solid var(--line);border-radius:10px;padding:10px 12px}
    details.month{border:1px solid #1d2a44;border-radius:10px;margin:10px 0;background:#0c1427}
    details summary{cursor:pointer;padding:10px 12px;font-weight:600}
    .right{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted)}
    .hidden{display:none}
    .tag{font-size:12px;border:1px solid #314263;border-radius:999px;padding:2px 8px;color:#c9d6ec}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <div class="logo">BetSpread</div>
    <span id="backendBadge" class="chip">Moln (Supabase)</span>
    <div class="grow"></div>

    <div class="right">
      <button id="upgradeBtn" class="btn btn-green">Uppgradera</button>
      <button id="manageBillingBtn" class="btn hidden">Hantera betalning</button>
      <span id="userEmail" class="muted"></span>
      <button id="logoutBtn" class="btn">Logga ut</button>
    </div>
  </div>
</header>

<main class="container">
  <!-- Projektkontroller -->
  <div class="card row" style="align-items:center">
    <div class="field" style="max-width:260px">
      <label>Projekt:</label>
      <select id="projectSelect"></select>
    </div>
    <button id="newProjectBtn" class="btn">Nytt projekt</button>
    <button id="renameProjectBtn" class="btn">Byt namn</button>
    <button id="deleteProjectBtn" class="btn btn-danger">Radera</button>
    <div class="grow"></div>
    <div id="freeBanner" class="banner hidden">Gratisläge: <b id="usedCount">0</b>/20 spel använda. Du har <b id="leftCount">20</b> kvar.</div>
  </div>

  <!-- Flikar -->
  <div class="tabs">
    <button class="tab active" data-tab="reg">Registrera spel</button>
    <button class="tab" data-tab="sum">Månadssummering</button>
    <button class="tab" data-tab="list">Spel</button>
  </div>

  <!-- Panel: Registrera spel -->
  <section id="panel-reg" class="panel active">
    <div class="row">
      <div class="field"><label>Matchdag</label><input type="date" id="dateInput"></div>
      <div class="field"><label>Match</label><input id="matchInput" placeholder="Arsenal — Chelsea"></div>
      <div class="field"><label>Marknad</label><input id="marketInput" placeholder="Över 8.5 frisparkar"></div>
      <div class="field"><label>Oddset</label><input id="oddsInput" type="number" step="0.01" placeholder="1.85"></div>
      <div class="field"><label>Insats</label><input id="stakeInput" type="number" step="0.01" value="1"></div>
      <div class="field"><label>Spelbolag</label><input id="bookInput" placeholder="Bet365"></div>
    </div>
    <div class="row" style="margin-top:10px">
      <div class="field" style="max-width:180px">
        <label>Resultat</label>
        <select id="resultInput">
          <option>Pending</option>
          <option>Win</option>
          <option>Loss</option>
          <option>Void</option>
        </select>
      </div>
      <div class="field" style="flex:2">
        <label>Notering</label>
        <input id="noteInput" placeholder="Ex. sent mål, cashout, etc.">
      </div>
      <div class="right" style="align-items:flex-end">
        <button id="addBetBtn" class="btn btn-green">Lägg till spel</button>
        <button id="resetProjectBtn" class="btn btn-danger">Nollställ projekt</button>
      </div>
    </div>
  </section>

  <!-- Panel: Månadssummering -->
  <section id="panel-sum" class="panel">
    <div class="row">
      <div class="field" style="max-width:220px">
        <label>Månad (matchdag)</label>
        <select id="monthFilter">
          <option value="all">Alla månader</option>
        </select>
      </div>
    </div>

    <div class="kpi" style="margin-top:10px">
      <div class="box">Spel (avgjorda): <b id="kpiSett">0</b> (<span id="kpiWL">Win 0 / Loss 0</span>)</div>
      <div class="box">Total insats: <b id="kpiStakes">0.00</b></div>
      <div class="box">Profit: <b id="kpiProfit">0.00</b></div>
      <div class="box">ROI: <b id="kpiROI">0.00%</b></div>
    </div>

    <div style="margin-top:12px">
      <table>
        <thead><tr><th>Månad</th><th>Spel (avgjorda)</th><th>Win</th><th>Loss</th><th>Insats</th><th>Profit</th><th>ROI</th></tr></thead>
        <tbody id="monthTable"></tbody>
      </table>
    </div>
  </section>

  <!-- Panel: Spel -->
  <section id="panel-list" class="panel">
    <div id="betsByMonth"></div>
  </section>
</main>

<script>
/* ---------------- Supabase config (din URL + anon key) ---------------- */
const SB = supabase.createClient(
  "https://updpywjfxeahtjpelbku.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwZHB5d2pmeGVhaHRqcGVsYmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MjQzOTcsImV4cCI6MjA3MjUwMDM5N30.i1ztG8dkcHFLq8WEn_uVrgCBk0_Wf5gZb_OQQuaSGgo"
);

/* ---------------- Helpers ---------------- */
const $ = (s)=>document.querySelector(s);
const monthNamesSV = ["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"];
const ymKey = (d)=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}`;
const niceMonth = (ym)=>{
  const [y,m]=ym.split("-").map(Number);
  return `${monthNamesSV[m-1]} ${y}`;
}
function fmt(n,dec=2){ return (Number(n||0)).toFixed(dec); }

/* ---------------- State ---------------- */
let user=null, profile=null;
let projects=[];
let currentProjectId=null;
let bets=[];           // bets for current project
let totalUsedCount=0;  // across all projects
let isPremium=false;

/* ---------------- Auth gate ---------------- */
(async function init(){
  const { data:{ session } } = await SB.auth.getSession();
  if(!session){ location.href = "login.html"; return; }
  user = session.user;
  $("#userEmail").textContent = user.email||"";
  await ensureUserRow();
  await loadProjects();
  bindUI();
  setToday();
  await refreshAll();
})();

/* Ensure users-row exists */
async function ensureUserRow(){
  // upsert by id
  const { data, error } = await SB.from("users")
    .upsert({ id: user.id, email: user.email }, { onConflict: "id", ignoreDuplicates: false })
    .select("id,is_premium")
    .single();
  if(!error && data){ isPremium = !!data.is_premium; }
  updatePremiumUI();
}

function updatePremiumUI(){
  const banner = $("#freeBanner");
  if(isPremium){
    banner.classList.add("hidden");
    $("#upgradeBtn").classList.add("hidden");
    $("#manageBillingBtn").classList.remove("hidden");
  }else{
    $("#upgradeBtn").classList.remove("hidden");
    $("#manageBillingBtn").classList.add("hidden");
  }
}

/* ---------------- Projects ---------------- */
async function loadProjects(){
  const { data, error } = await SB.from("projects").select("id,name").order("created_at",{ascending:true}).eq("user_id", user.id);
  if(error){ console.error(error); return; }
  projects = data||[];
  if(projects.length===0){
    const { data:created } = await SB.from("projects").insert({ user_id:user.id, name:"Mitt första projekt" }).select().single();
    projects = [created];
  }
  // fill select
  const sel = $("#projectSelect");
  sel.innerHTML="";
  projects.forEach(p=>{
    const opt=document.createElement("option");
    opt.value=p.id; opt.textContent=p.name;
    sel.appendChild(opt);
  });
  currentProjectId = sel.value = projects[0].id;
  sel.onchange = async ()=>{ currentProjectId = sel.value; await refreshAll(); };
}

$("#newProjectBtn").onclick = async ()=>{
  const name = prompt("Namn på nytt projekt:", "Nytt projekt");
  if(!name) return;
  const { data, error } = await SB.from("projects").insert({ user_id:user.id, name }).select().single();
  if(!error){ projects.push(data); await loadProjects(); await refreshAll(); }
};
$("#renameProjectBtn").onclick = async ()=>{
  if(!currentProjectId) return;
  const current = projects.find(p=>p.id==currentProjectId);
  const name = prompt("Nytt namn:", current?.name||"Projekt");
  if(!name) return;
  const { error } = await SB.from("projects").update({ name }).eq("id", currentProjectId);
  if(!error){ await loadProjects(); }
};
$("#deleteProjectBtn").onclick = async ()=>{
  if(!currentProjectId) return;
  if(!confirm("Radera projektet och alla dess spel?")) return;
  await SB.from("bets").delete().eq("project_id", currentProjectId);
  await SB.from("projects").delete().eq("id", currentProjectId);
  await loadProjects(); await refreshAll();
};
$("#resetProjectBtn").onclick = async ()=>{
  if(!currentProjectId) return;
  if(!confirm("Ta bort alla spel i detta projekt?")) return;
  await SB.from("bets").delete().eq("project_id", currentProjectId);
  await refreshAll();
};

/* ---------------- Bets: CRUD + load ---------------- */
async function refreshAll(){
  await loadPremiumUsage();
  await loadBets();
  buildMonthFilter();
  renderSummary();
  renderBetsGrouped();
}

async function loadPremiumUsage(){
  // count all bets for this user
  const { count, error } = await SB.from("bets")
    .select("id", { count:"exact", head:true })
    .eq("user_id", user.id);
  totalUsedCount = count||0;
  const left = Math.max(0, 20 - totalUsedCount);
  $("#usedCount").textContent = totalUsedCount;
  $("#leftCount").textContent = left;
  if(!isPremium) $("#freeBanner").classList.remove("hidden");
}

async function loadBets(){
  const { data, error } = await SB.from("bets")
    .select("id,matchday,match,market,odds,stake,book,result,note,created_at")
    .eq("user_id", user.id)
    .eq("project_id", currentProjectId)
    .order("matchday", { ascending:false });
  bets = data||[];
}

$("#addBetBtn").onclick = async ()=>{
  if(!isPremium && totalUsedCount >= 20){
    alert("Du har nått gränsen 20 spel i gratisläget. Uppgradera för obegränsat.");
    return;
  }
  const md = $("#dateInput").value;
  const match = $("#matchInput").value.trim();
  const market = $("#marketInput").value.trim();
  const odds = parseFloat($("#oddsInput").value||"0");
  const stake = parseFloat($("#stakeInput").value||"1");
  const book = $("#bookInput").value.trim();
  const result = $("#resultInput").value;
  const note = $("#noteInput").value.trim();

  if(!md || !match || !market || !odds || !stake){
    alert("Fyll i matchdag, match, marknad, odds och insats.");
    return;
  }
  const { error } = await SB.from("bets").insert({
    user_id: user.id,
    project_id: currentProjectId,
    matchday: md,
    match, market, odds, stake, book, result, note
  });
  if(error){ alert("Kunde inte spara spelet"); console.error(error); return; }
  // clear small fields
  $("#matchInput").value=""; $("#marketInput").value=""; $("#noteInput").value="";
  $("#oddsInput").value=""; $("#stakeInput").value="1"; $("#bookInput").value="";
  $("#resultInput").value="Pending";
  await refreshAll();
};

/* ---------------- Summary + List rendering ---------------- */
function buildMonthFilter(){
  const sel=$("#monthFilter");
  const prevVal = sel.value;
  const months = Array.from(new Set(bets.map(b=>ymKey(new Date(b.matchday))))).sort().reverse();
  sel.innerHTML='<option value="all">Alla månader</option>';
  months.forEach(ym=>{
    const opt=document.createElement("option");
    opt.value=ym; opt.textContent=niceMonth(ym);
    sel.appendChild(opt);
  });
  sel.value = prevVal && Array.from(sel.options).some(o=>o.value===prevVal) ? prevVal : "all";
  sel.onchange = renderSummary;
}

function renderSummary(){
  const ym = $("#monthFilter").value;
  const filtered = ym==="all" ? bets : bets.filter(b=>ymKey(new Date(b.matchday))===ym);
  const settled = filtered.filter(b=>b.result==="Win"||b.result==="Loss"||b.result==="Void");

  const stakes = settled.reduce((s,b)=>s + (b.result==="Void"?0:b.stake), 0);
  const profit = settled.reduce((p,b)=>{
    if(b.result==="Win") return p + (b.odds*b.stake - b.stake);
    if(b.result==="Loss") return p - b.stake;
    return p;
  },0);
  const wins = settled.filter(b=>b.result==="Win").length;
  const losses = settled.filter(b=>b.result==="Loss").length;
  const roi = stakes>0 ? (profit/stakes)*100 : 0;

  $("#kpiSett").textContent = settled.length;
  $("#kpiWL").textContent = `Win ${wins} / Loss ${losses}`;
  $("#kpiStakes").textContent = fmt(stakes);
  $("#kpiProfit").textContent = fmt(profit);
  $("#kpiROI").textContent = fmt(roi,2)+"%";

  // month table (group all months regardless of filter, to give överblick)
  const tbody=$("#monthTable"); tbody.innerHTML="";
  const groups={};
  bets.forEach(b=>{
    const key = ymKey(new Date(b.matchday));
    (groups[key] ||= []).push(b);
  });
  Object.keys(groups).sort().reverse().forEach(key=>{
    const arr = groups[key].filter(b=>b.result!=="Pending");
    const st = arr.reduce((s,b)=>s+(b.result==="Void"?0:b.stake),0);
    const pr = arr.reduce((p,b)=>{
      if(b.result==="Win") return p + (b.odds*b.stake - b.stake);
      if(b.result==="Loss") return p - b.stake;
      return p;
    },0);
    const w = arr.filter(b=>b.result==="Win").length;
    const l = arr.filter(b=>b.result==="Loss").length;
    const roi = st>0 ? (pr/st)*100 : 0;
    const tr=document.createElement("tr");
    tr.innerHTML = `<td>${niceMonth(key)}</td>
      <td>${arr.length}</td><td>${w}</td><td>${l}</td>
      <td>${fmt(st)}</td><td>${fmt(pr)}</td><td>${fmt(roi)}%</td>`;
    tbody.appendChild(tr);
  });
}

function renderBetsGrouped(){
  const wrap=$("#betsByMonth"); wrap.innerHTML="";
  const groups={};
  bets.forEach(b=>{
    const key = ymKey(new Date(b.matchday));
    (groups[key] ||= []).push(b);
  });
  Object.keys(groups).sort().reverse().forEach(key=>{
    const list = groups[key];
    const det=document.createElement("details");
    det.className="month"; det.open=false;
    const settled = list.filter(b=>b.result!=="Pending").length;
    det.innerHTML = `<summary>${niceMonth(key)} <span class="tag" style="margin-left:8px">${list.length} spel</span> <span class="tag">${settled} avgjorda</span></summary>`;
    const tbl=document.createElement("table");
    const thead=document.createElement("thead");
    thead.innerHTML="<tr><th>Matchdag</th><th>Match</th><th>Marknad</th><th>Odds</th><th>Insats</th><th>Resultat</th><th>Spelbolag</th><th>Notering</th></tr>";
    const tbody=document.createElement("tbody");
    list.forEach(b=>{
      const tr=document.createElement("tr");
      tr.innerHTML = `<td>${b.matchday}</td><td>${escapeHtml(b.match)}</td><td>${escapeHtml(b.market)}</td>
        <td>${fmt(b.odds,2)}</td><td>${fmt(b.stake,2)}</td><td>${b.result}</td><td>${escapeHtml(b.book||"")}</td><td>${escapeHtml(b.note||"")}</td>`;
      tbody.appendChild(tr);
    });
    tbl.appendChild(thead); tbl.appendChild(tbody);
    det.appendChild(tbl);
    wrap.appendChild(det);
  });
}

function escapeHtml(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---------------- Tabs ---------------- */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    document.querySelectorAll(".panel").forEach(p=>p.classList.remove("active"));
    btn.classList.add("active");
    const id = btn.dataset.tab;
    $("#panel-"+id).classList.add("active");
  };
});

/* ---------------- Topbar actions ---------------- */
$("#logoutBtn").onclick = async ()=>{
  await SB.auth.signOut();
  location.href = "index.html"; // tillbaka till landningssidan
};

$("#upgradeBtn").onclick = async ()=>{
  try{
    const res = await fetch("/api/create-checkout-session", { method:"POST" });
    const data = await res.json();
    if(data?.url) window.location.href = data.url;
    else alert(data?.error || "Kunde inte starta Stripe Checkout");
  }catch(e){ alert("Nätverksfel mot Stripe"); }
};

$("#manageBillingBtn").onclick = async ()=>{
  // (valfritt) om du skapar api/create-portal-session
  try{
    const res = await fetch("/api/create-portal-session", { method:"POST" });
    const data = await res.json();
    if(data?.url) window.location.href = data.url;
  }catch(e){}
};

/* ---------------- Misc ---------------- */
function setToday(){
  const t = new Date();
  const yyyy=t.getFullYear(), mm=String(t.getMonth()+1).padStart(2,"0"), dd=String(t.getDate()).padStart(2,"0");
  $("#dateInput").value = `${yyyy}-${mm}-${dd}`;
}

/* ---------------- URL feedback after checkout ---------------- */
(function(){
  const p = new URLSearchParams(location.search);
  if(p.get("upgrade")==="success"){ alert("Tack! Din betalning är klar. Premium aktiveras strax."); }
})();
</script>
</body>
</html>
