<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BetSpread – App</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>

<link rel="stylesheet" href="./app.css">

</head>
<body>
  <div class="app-shell">
    <header class="app-header">
      <div class="brand">BetSpread</div>
      <div class="header-meta">
        <span id="userEmail" class="chip">…</span>
        <button id="manageBillingBtn" class="btn ghost hide">Hantera</button>
        <button id="upgradeBtn" class="btn primary">Uppgradera</button>
        <button id="logoutBtn" class="btn danger">Logga ut</button>
      </div>
    </header>

    <div id="freeBanner" class="notice hide">
      Gratisläge: <span id="usedCount">0</span>/20 spel använda. Du har <span id="leftCount">20</span> kvar.
    </div>

    <main class="app-main">
      <section class="primary">
        <section class="panel project-card">
          <div class="project-meta">
            <span class="label">Aktivt projekt</span>
            <span id="projectTitle" class="value">Inget projekt valt</span>
            <p class="subtle">Du har <span id="projectCount">0</span> projekt.</p>
          </div>
          <div class="project-actions">
            <select id="projectSelect" aria-label="Välj projekt"></select>
            <button id="newProjectBtn" class="btn ghost" type="button">Nytt</button>
            <button id="renameProjectBtn" class="btn ghost" type="button">Byt namn</button>
            <button id="deleteProjectBtn" class="btn danger" type="button">Radera</button>
          </div>
        </section>

        <div class="tabs" role="tablist">
          <button class="tab active" data-tab="reg" role="tab" aria-selected="true">Registrera spel</button>
          <button class="tab" data-tab="summary" role="tab" aria-selected="false">Månadssummering</button>
          <button class="tab" data-tab="list" role="tab" aria-selected="false">Spel</button>
        </div>

        <section id="tab-reg" class="panel tab-panel" role="tabpanel" aria-labelledby="Registrera spel">
          <div class="form-grid">
            <div class="col-3">
              <label for="iDate">Matchdag</label>
              <input id="iDate" type="date" />
            </div>
            <div class="col-4">
              <label for="iMatch">Match</label>
              <input id="iMatch" type="text" placeholder="Arsenal — Chelsea" />
            </div>
            <div class="col-3">
              <label for="iMarket">Marknad</label>
              <input id="iMarket" type="text" placeholder="Över 8.5 frisparkar" />
            </div>
            <div class="col-2">
              <label for="iOdds">Oddset</label>
              <input id="iOdds" type="number" step="0.01" min="1.01" placeholder="1.85" />
            </div>
            <div class="col-2">
              <label for="iStake">Insats</label>
              <input id="iStake" type="number" step="1" min="1" value="1" />
            </div>
            <div class="col-3">
              <label for="iBook">Spelbolag</label>
              <input id="iBook" type="text" placeholder="Bet365" />
            </div>
            <div class="col-3">
              <label for="iResult">Resultat</label>
              <select id="iResult">
                <option>Pending</option>
                <option>Win</option>
                <option>Loss</option>
                <option>Void</option>
              </select>
            </div>
            <div class="col-6 form-actions">
              <button id="cancelEditBtn" class="btn ghost hide" type="button">Avbryt redigering</button>
              <button id="addBetBtn" class="btn primary" type="button">Lägg till spel</button>
              <button id="resetProjectBtn" class="btn danger" type="button">Nollställ projekt</button>
            </div>
          </div>
        </section>

        <section id="tab-summary" class="panel tab-panel hide" role="tabpanel" aria-labelledby="Månadssummering">
          <div class="form-grid" style="margin-bottom: 16px;">
            <div class="col-4">
              <label for="monthFilter">Månad (matchdag)</label>
              <select id="monthFilter"></select>
            </div>
          </div>
          <div class="summary-grid">
            <div class="summary-card">
              <span class="label">Spel (avgjorda)</span>
              <span id="sGames" class="value">0</span>
            </div>
            <div class="summary-card">
              <span class="label">Vinster</span>
              <span id="sWins" class="value">0</span>
            </div>
            <div class="summary-card">
              <span class="label">Profit</span>
              <span id="sProfit" class="value">0.00</span>
            </div>
            <div class="summary-card">
              <span class="label">ROI</span>
              <span id="sRoi" class="value">0.00%</span>
            </div>
          </div>
          <div class="summary-meta" style="margin-top: 20px;">
            <span class="label">Vald period</span>
            <div id="sMonthName" class="value">Alla månader</div>
          </div>
        </section>

        <section id="tab-list" class="panel tab-panel hide" role="tabpanel" aria-labelledby="Spel">
          <div id="playsContainer"></div>
        </section>
      </section>

      <aside class="sidebar">
        <section class="panel stats-panel">
          <h2>Snabböversikt</h2>
          <div class="overview-grid">
            <div class="overview-card">
              <span class="label">Spel totalt</span>
              <span id="quickTotal" class="value">0</span>
            </div>
            <div class="overview-card">
              <span class="label">Pågående</span>
              <span id="quickPending" class="value">0</span>
            </div>
            <div class="overview-card">
              <span class="label">ROI</span>
              <span id="quickRoi" class="value">–</span>
            </div>
            <div class="overview-card">
              <span class="label">Profit</span>
              <span id="quickProfit" class="value">0.00</span>
            </div>
          </div>
        </section>

<style>
  :root{
    --bg:#050b17;
    --panel:rgba(12,22,39,0.92);
    --panel-strong:rgba(17,31,52,0.95);
    --muted:rgba(22,34,54,0.8);
    --text:#f1f5ff;
    --sub:#8ca3cc;
    --accent:#60a5fa;
    --accent-2:#4ade80;
    --danger:#ef4444;
    --btn:rgba(42,60,100,0.9);
    --btn-h:rgba(58,82,134,0.95);
    --tab:rgba(20,33,54,0.6);
    --tab-a:rgba(47,85,151,0.82);
    --shadow:0 28px 65px -35px rgba(7,11,24,0.9);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    background:linear-gradient(180deg,#040914,#0d1729);
    color:var(--text);
    font:16px/1.5 "Inter","Segoe UI",-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;
    position:relative;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:radial-gradient(50% 60% at 18% 14%,rgba(96,165,250,0.22) 0%,rgba(5,11,23,0) 100%),
      radial-gradient(55% 65% at 80% 12%,rgba(99,102,241,0.18) 0%,rgba(5,11,23,0) 100%);
    pointer-events:none;
    z-index:-1;
  }
  .container{
    width:100%;
    max-width:1220px;
    margin:0 auto;
    padding:36px 22px 64px;
  }
  header.top-bar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:24px;
    margin-bottom:24px;
    padding:22px 26px;
    border-radius:var(--radius);
    background:var(--panel-strong);
    border:1px solid rgba(74,96,138,0.38);
    box-shadow:var(--shadow);
    backdrop-filter:blur(12px);
  }
  .brand-block{display:flex;flex-direction:column;gap:6px}
  .brand{
    font-weight:800;
    font-size:28px;
    letter-spacing:.02em;
    background:linear-gradient(135deg,#a855f7,#38bdf8);
    -webkit-background-clip:text;
    color:transparent;
  }
  .tagline{margin:0;font-size:14px;color:var(--sub)}
  .right-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  button,.btn{
    background:var(--btn);
    border:1px solid rgba(96,119,173,0.45);
    color:var(--text);
    border-radius:12px;
    padding:10px 16px;
    cursor:pointer;
    transition:background .2s ease,transform .2s ease,border-color .2s ease;
    font-weight:600;
    letter-spacing:.01em;
  }
  button:hover,.btn:hover{background:var(--btn-h);transform:translateY(-1px);}
  button:focus-visible,.btn:focus-visible{outline:2px solid var(--accent);outline-offset:3px;}
  .btn-green{background:linear-gradient(135deg,#34d399,#10b981);border:none;box-shadow:0 12px 32px -20px rgba(16,185,129,0.7);}
  .btn-green:hover{filter:brightness(1.05);}
  .btn-red{background:linear-gradient(135deg,#f87171,#ef4444);border:none;box-shadow:0 12px 32px -20px rgba(239,68,68,0.65);}
  .btn-red:hover{filter:brightness(1.05);}
  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 14px;
    border-radius:999px;
    background:rgba(59,130,246,0.12);
    border:1px solid rgba(96,165,250,0.35);
    color:var(--accent);
    font-weight:600;
    font-size:14px;
  }
  .banner{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:18px;
    padding:18px 22px;
    margin-bottom:24px;
    border-radius:var(--radius);
    background:linear-gradient(135deg,rgba(248,113,113,0.2),rgba(248,113,113,0.08));
    border:1px solid rgba(248,113,113,0.45);
    color:#ffe1e1;
    box-shadow:0 18px 45px -30px rgba(248,113,113,0.45);
  }
  .banner h2{margin:0 0 4px;font-size:18px;color:#ffe1e1;}
  .banner p{margin:0;font-size:15px;color:#ffd9d9;line-height:1.45;}
  .workspace{
    display:grid;
    grid-template-columns:minmax(0,1fr) 320px;
    gap:24px;
    align-items:flex-start;
  }
  .primary,.secondary{display:flex;flex-direction:column;gap:24px;}
  .panel{
    background:var(--panel);
    border:1px solid rgba(74,96,138,0.38);
    border-radius:var(--radius);
    padding:24px;
    box-shadow:var(--shadow);
    backdrop-filter:blur(12px);
  }
  .panel h2{margin:0;font-size:20px;font-weight:700;letter-spacing:.01em;}
  .hint{color:var(--sub);font-size:14px;}
  .subtle{color:var(--sub);font-size:13px;}
  .section-header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:20px;
    margin-bottom:20px;
  }
  .section-header .project-meta{display:flex;align-items:center;gap:8px;color:var(--sub);font-size:13px;}
  .section-header .project-meta strong{color:var(--text);font-size:16px;}
  .project-controls{display:flex;flex-direction:column;gap:16px;}
  .project-controls label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .control-row{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
  .control-row select{flex:1;min-width:220px;}
  .button-cluster{display:flex;flex-wrap:wrap;gap:10px;}
  select,input,textarea{
    background:rgba(10,20,35,0.85);
    border:1px solid rgba(78,106,150,0.4);
    color:var(--text);
    padding:12px 14px;
    border-radius:12px;
    font-size:15px;
    transition:border .2s ease,box-shadow .2s ease,background .2s ease;
  }
  select:focus-visible,input:focus-visible,textarea:focus-visible{
    border-color:rgba(96,165,250,0.8);
    box-shadow:0 0 0 3px rgba(96,165,250,0.2);
    outline:none;
  }
  textarea{resize:vertical;min-height:96px;}
  .tabs{
    display:flex;
    gap:12px;
    padding:6px;
    background:rgba(15,26,44,0.7);
    border:1px solid rgba(72,95,142,0.35);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  .tab{
    flex:1;
    padding:12px 16px;
    border-radius:12px;
    border:1px solid transparent;
    background:transparent;
    color:var(--sub);
    font-weight:600;
    letter-spacing:.02em;
    cursor:pointer;
    transition:background .2s ease,color .2s ease,border .2s ease,transform .2s ease;
  }
  .tab:hover{color:var(--text);transform:translateY(-1px);}
  .tab.active{
    background:linear-gradient(135deg,rgba(96,165,250,0.28),rgba(56,189,248,0.16));
    border-color:rgba(96,165,250,0.5);
    color:var(--text);
    box-shadow:0 12px 28px -20px rgba(96,165,250,0.7);
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(12,minmax(0,1fr));
    gap:16px;
  }
  .grid .field{display:flex;flex-direction:column;gap:6px;}
  .grid label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .col-1{grid-column:span 1;}
  .col-2{grid-column:span 2;}
  .col-3{grid-column:span 3;}
  .col-4{grid-column:span 4;}
  .col-5{grid-column:span 5;}
  .col-6{grid-column:span 6;}
  .col-12{grid-column:span 12;}
  .actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
  .action-field{align-self:end;}
  .sr-only{
    position:absolute;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }
  .summary-panel .filter{display:flex;flex-direction:column;gap:8px;min-width:190px;}
  .summary-panel select{min-width:190px;}
  .stat-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:16px;
  }
  .stat-card{
    padding:18px;
    border-radius:14px;
    background:rgba(18,32,54,0.8);
    border:1px solid rgba(73,103,152,0.4);
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .stat-card .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .stat-card .value{font-size:26px;font-weight:700;}
  .trend-card{
    margin-top:20px;
    padding:18px;
    border-radius:14px;
    background:rgba(22,36,58,0.8);
    border:1px solid rgba(72,103,152,0.35);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .trend-card .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .trend-card .value{font-size:18px;font-weight:600;}
  #playsContainer{display:flex;flex-direction:column;gap:16px;}
  details.month{
    border-radius:var(--radius);
    border:1px solid rgba(72,103,152,0.35);
    background:rgba(17,29,49,0.75);
    overflow:hidden;
    box-shadow:var(--shadow);
  }
  details.month summary{
    list-style:none;
    padding:18px 22px;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    cursor:pointer;
    background:linear-gradient(135deg,rgba(96,165,250,0.2),rgba(56,189,248,0.08));
  }
  details.month summary::-webkit-details-marker{display:none;}
  details.month[open] summary{border-bottom:1px solid rgba(72,103,152,0.35);background:linear-gradient(135deg,rgba(96,165,250,0.08),rgba(56,189,248,0.05));}
  .month-count{font-size:14px;color:var(--sub);}
  .row{
    display:grid;
    grid-template-columns:120px 1.8fr 90px 90px 150px 1.4fr 220px;
    gap:16px;
    padding:16px 22px;
    align-items:flex-start;
  }
  .row-head{
    background:rgba(255,255,255,0.02);
    font-size:12px;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--sub);
    font-weight:600;
    padding-top:14px;
    padding-bottom:14px;
  }
  .row:not(.row-head):nth-child(odd){background:rgba(10,18,32,0.3);}
  .row > div{min-width:0;}
  .cell-match .match{font-weight:600;display:block;}
  .cell-match .market{display:block;font-size:13px;color:var(--sub);margin-top:2px;}
  .note-cell{font-size:14px;line-height:1.4;opacity:.92;}
  .actions{justify-content:flex-start;}
  .pill{
    padding:6px 12px;
    border-radius:999px;
    background:rgba(27,43,73,0.9);
    border:1px solid rgba(71,103,152,0.4);
    font-size:13px;
    font-weight:600;
    color:var(--text);
    transition:transform .15s ease,background .2s ease,border .2s ease;
    cursor:pointer;
  }
  .pill:hover{transform:translateY(-1px);background:rgba(46,69,104,0.95);}
  .pill.win{background:rgba(22,101,52,0.28);border-color:rgba(134,239,172,0.45);color:#86efac;}
  .pill.loss{background:rgba(153,27,27,0.28);border-color:rgba(248,113,113,0.5);color:#fca5a5;}
  .pill.pending{background:rgba(30,64,175,0.25);border-color:rgba(129,140,248,0.45);color:#c7d2fe;}
  .pill.void{background:rgba(107,114,128,0.25);border-color:rgba(156,163,175,0.45);color:#e5e7eb;}
  .pill[data-del]{background:rgba(120,31,46,0.25);border-color:rgba(239,68,68,0.45);color:#fca5a5;}
  .empty-state{
    padding:32px 24px;
    text-align:center;
    background:rgba(17,31,52,0.75);
    border:1px dashed rgba(99,102,241,0.35);
    border-radius:var(--radius);
    color:var(--sub);
    font-size:15px;
    line-height:1.6;
  }
  .highlight-panel{position:sticky;top:24px;}
  .overview-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    gap:16px;
    margin-top:18px;
  }
  .overview-card{
    padding:16px;
    border-radius:14px;
    background:rgba(18,32,54,0.72);
    border:1px solid rgba(72,103,152,0.35);
    display:flex;
    flex-direction:column;
    gap:6px;
    transition:transform .2s ease,border .2s ease,background .2s ease;
  }
  .overview-card:hover{transform:translateY(-2px);border-color:rgba(96,165,250,0.5);background:rgba(21,38,62,0.8);}
  .overview-card .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .overview-card .value{font-size:24px;font-weight:700;}
  .tip-panel ul{margin:12px 0 0;padding-left:20px;color:var(--sub);line-height:1.6;}
  .tip-panel li strong{color:var(--text);}
  .hide{display:none!important;}
  @media (max-width:1100px){
    .workspace{grid-template-columns:1fr;}
    .secondary{flex-direction:row;flex-wrap:wrap;}
    .highlight-panel{position:static;}
    .row{grid-template-columns:110px 1.6fr 80px 80px 140px 1.2fr 200px;}
    .grid{grid-template-columns:repeat(6,minmax(0,1fr));}
    .col-1,.col-2{grid-column:span 3;}
    .col-3{grid-column:span 3;}
    .col-4,.col-6{grid-column:span 6;}
  }
  @media (max-width:900px){
    .row-head{display:none;}
    .row{grid-template-columns:repeat(2,minmax(0,1fr));padding:14px 18px;border-bottom:1px solid rgba(72,103,152,0.25);}
    .row:not(.row-head) > div{display:flex;flex-direction:column;gap:4px;}
    .row:not(.row-head) > div::before{content:attr(data-label);font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);font-weight:600;}
    .actions{justify-content:flex-start;}
  }
  @media (max-width:760px){
    .secondary{flex-direction:column;}
  }
  @media (max-width:720px){
    .grid{grid-template-columns:repeat(1,minmax(0,1fr));}
    .col-1,.col-2,.col-3,.col-4,.col-6,.col-12{grid-column:span 1;}
    .action-field{align-self:auto;}
    .actions{flex-direction:column;align-items:stretch;}
    .tabs{flex-direction:column;}
  }
  @media (max-width:640px){
    header.top-bar{flex-direction:column;align-items:flex-start;}
    .right-actions{justify-content:flex-start;width:100%;}
  }
  @media (max-width:480px){
    .right-actions{gap:10px;}
    .right-actions button{width:100%;}
    .badge{width:100%;justify-content:center;}
    .banner{flex-direction:column;align-items:flex-start;}
  }
</style>
</head>
<body>
  <div class="container">
    <header class="top-bar">
      <div class="brand-block">
        <div class="brand">BetSpread</div>
        <p class="tagline">Planera, följ upp och förbättra dina spel.</p>
      </div>
      <div class="right-actions">
        <span id="userEmail" class="badge">…</span>
        <button id="manageBillingBtn" title="Hantera abonnemang" class="hide">Hantera</button>
        <button id="upgradeBtn" class="btn-green">Uppgradera</button>
        <button id="logoutBtn" class="btn-red">Logga ut</button>
      </div>
    </header>

    <div id="freeBanner" class="banner hide">
      <div>
        <h2>Gratisläge</h2>
        <p>Du har använt <strong id="usedCount">0</strong> av 20 spel. <br>Återstår: <strong id="leftCount">20</strong> spel.</p>
      </div>
      <span class="hint">Uppgradera för obegränsade registreringar.</span>
    </div>

    <main class="workspace">
      <section class="primary">
        <div class="panel project-panel">
          <div class="section-header">
            <div>
              <h2>Projekt</h2>
              <p class="hint" id="projectTitle">Inget projekt valt</p>
            </div>
            <div class="project-meta">Projekt totalt: <strong id="projectCount">0</strong></div>
          </div>
          <div class="project-controls">
            <label for="projectSelect">Välj projekt</label>
            <div class="control-row">
              <select id="projectSelect"></select>
              <div class="button-cluster">
                <button id="newProjectBtn">Nytt projekt</button>
                <button id="renameProjectBtn">Byt namn</button>
                <button id="deleteProjectBtn" class="btn-red">Radera</button>
              </div>
            </div>
          </div>
        </div>

        <nav class="tabs" role="tablist">
          <button type="button" id="tab-reg-btn" class="tab active" data-tab="reg" role="tab" aria-controls="tab-reg" aria-selected="true">Registrera spel</button>
          <button type="button" id="tab-summary-btn" class="tab" data-tab="summary" role="tab" aria-controls="tab-summary" aria-selected="false">Månadssummering</button>
          <button type="button" id="tab-list-btn" class="tab" data-tab="list" role="tab" aria-controls="tab-list" aria-selected="false">Spel</button>
        </nav>

        <section id="tab-reg" class="panel form-panel" role="tabpanel" aria-labelledby="tab-reg-btn" aria-hidden="false">
          <div class="section-header">
            <div>
              <h2>Registrera spel</h2>
              <p class="hint">Fyll i matchinformationen och klicka på &quot;Lägg till spel&quot; för att spara.</p>
            </div>
            <span class="subtle">Alla fält är obligatoriska</span>
          </div>
          <div class="grid">
            <div class="col-2 field">
              <label for="iDate">Matchdag</label>
              <input id="iDate" type="date" />
            </div>
            <div class="col-3 field">
              <label for="iMatch">Match</label>
              <input id="iMatch" type="text" placeholder="Arsenal — Chelsea" />
            </div>
            <div class="col-3 field">
              <label for="iMarket">Marknad</label>
              <input id="iMarket" type="text" placeholder="Över 8.5 frisparkar" />
            </div>
            <div class="col-2 field">
              <label for="iOdds">Oddset</label>
              <input id="iOdds" type="number" step="0.01" min="1.01" placeholder="1.85" />
            </div>
            <div class="col-1 field">
              <label for="iStake">Insats</label>
              <input id="iStake" type="number" step="1" min="1" value="1" />
            </div>
            <div class="col-1 field">
              <label for="iBook">Spelbolag</label>
              <input id="iBook" type="text" placeholder="Bet365" />
            </div>
            <div class="col-2 field">
              <label for="iResult">Resultat</label>
              <select id="iResult">
                <option>Pending</option>
                <option>Win</option>
                <option>Loss</option>
                <option>Void</option>
              </select>
            </div>
            <div class="col-6 field">
              <label for="iNote">Notering</label>
              <input id="iNote" type="text" placeholder="Ex. sent mål, cashout, etc." />
            </div>
            <div class="col-4 field action-field">
              <span class="sr-only">Åtgärder</span>
              <div class="actions">
                <button id="addBetBtn" class="btn-green">Lägg till spel</button>
                <button id="resetProjectBtn" class="btn-red">Nollställ projekt</button>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-summary" class="panel summary-panel hide" role="tabpanel" aria-labelledby="tab-summary-btn" aria-hidden="true">
          <div class="section-header">
            <div>
              <h2>Månadssummering</h2>
              <p class="hint">Analysera avgjorda spel och följ ROI per månad.</p>
            </div>
            <div class="filter">
              <label for="monthFilter">Månad (matchdag)</label>
              <select id="monthFilter"></select>
            </div>
          </div>
          <div class="stat-grid">
            <div class="stat-card"><span class="label">Spel (avgjorda)</span><span id="sGames" class="value">0</span></div>
            <div class="stat-card"><span class="label">Vinster</span><span id="sWins" class="value">0</span></div>
            <div class="stat-card"><span class="label">Profit</span><span id="sProfit" class="value">0.00</span></div>
            <div class="stat-card"><span class="label">ROI</span><span id="sRoi" class="value">0.00%</span></div>
          </div>
          <div class="trend-card">
            <span class="label">Visar</span>
            <span id="sMonthName" class="value">-</span>
          </div>
        </section>

        <section id="tab-list" class="panel list-panel hide" role="tabpanel" aria-labelledby="tab-list-btn" aria-hidden="true">
          <div class="section-header">
            <div>
              <h2>Spel</h2>
              <p class="hint">Hantera registrerade spel och uppdatera resultaten.</p>
            </div>
          </div>
          <div id="playsContainer"></div>
        </section>
      </section>

      <aside class="secondary">
        <section class="panel highlight-panel">
          <h2>Snabböversikt</h2>
          <p class="hint">Få koll på projektets status utan att lämna formuläret.</p>
          <div class="overview-grid">
            <div class="overview-card"><span class="label">Spel totalt</span><span id="quickTotal" class="value">0</span></div>
            <div class="overview-card"><span class="label">Pågående</span><span id="quickPending" class="value">0</span></div>
            <div class="overview-card"><span class="label">Vinstrate</span><span id="quickWinRate" class="value">–</span></div>
            <div class="overview-card"><span class="label">Profit</span><span id="quickProfit" class="value">0.00</span></div>
          </div>
        </section>
        <section class="panel tip-panel">
          <h2>Tips</h2>
          <ul class="tips-list">
            <li><strong>Byt projekt</strong> i listan för att se andra spel.</li>
            <li><strong>Använd flikarna</strong> för att registrera spel eller analysera resultat.</li>
            <li><strong>Uppdatera resultat</strong> i spel-listan så hålls statistiken aktuell.</li>
          </ul>
        </section>
 main
      </aside>
    </main>
  </div>


  <script type="module" src="./app.js"></script>

<script type="module">
  // ======= KONFIG =======
  const SUPABASE_URL = "https://updpywjfxeahtjpelbku.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwZHB5d2pmeGVhaHRqcGVsYmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MjQzOTcsImV4cCI6MjA3MjUwMDM5N30.i1ztG8dkcHFLq8WEn_uVrgCBk0_Wf5gZb_OQQuaSGgo";

  // ======= LIBS =======
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm";
  const SB = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // ======= STATE =======
  let currentUser = null;
  let currentProject = null; // {id, name}
  let projects = []; // [{id,name}]
  let bets = [];     // alla bets för valt projekt

  // ======= UI HELPERS =======
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const fmtMoney = v => (Math.round(v * 100)/100).toFixed(2);
  const svMonth = (y,m) => new Date(y, m-1, 1).toLocaleDateString("sv-SE",{month:"long",year:"numeric"});

  function setTab(name){
    $$(".tab").forEach(t => {
      const active = t.dataset.tab === name;
      t.classList.toggle("active", active);
      t.setAttribute("aria-selected", active ? "true" : "false");
    });
    const reg = $("#tab-reg");
    const summary = $("#tab-summary");
    const list = $("#tab-list");
    if(reg){ reg.classList.toggle("hide", name!=="reg"); reg.setAttribute("aria-hidden", name!=="reg"); }
    if(summary){ summary.classList.toggle("hide", name!=="summary"); summary.setAttribute("aria-hidden", name!=="summary"); }
    if(list){ list.classList.toggle("hide", name!=="list"); list.setAttribute("aria-hidden", name!=="list"); }
  }

  $$(".tab").forEach(t => t.addEventListener("click",()=>setTab(t.dataset.tab)));

  // ======= AUTH =======
  async function ensureProfileRow(){
    if(!currentUser) return;
    try{
      const payload = { id: currentUser.id };
      if(currentUser.email) payload.email = currentUser.email;
      const { error } = await SB.from("users").upsert(payload, { onConflict: "id" });
      if(error) console.error("Kunde inte skapa/uppdatera användarrad", error);
    }catch(err){
      console.error("ensureProfileRow fel", err);
    }
  }

  async function ensureAuth(){
    const { data: { session } } = await SB.auth.getSession();
    if(!session){
      location.href = "/login.html";
      throw new Error("NOT_AUTHENTICATED");
    }
    currentUser = session.user;
    $("#userEmail").textContent = currentUser.email || "Ingen e-post";
    await ensureProfileRow();
  }

  $("#logoutBtn").onclick = async () => { await SB.auth.signOut(); location.href="/"; };

  // ======= STRIPE KNAPPAR =======
  async function callStripeCheckout(){
    try{
      const { data: { session } } = await SB.auth.getSession();
      const u = session?.user;
      if(!u?.id){
        alert("Sessionen är ogiltig. Logga in igen.");
        return;
      }
      currentUser = u;
      await ensureProfileRow();
      const r = await fetch("/api/create-checkout-session", {
        method:"POST",
        headers:{ "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: u?.id, email: u?.email })
      });
      const d = await r.json();
      if(d?.url) location.href = d.url; else alert(d?.error || "Kunde inte starta Stripe Checkout");
    }catch(e){ alert("Nätverksfel mot Stripe"); }
  }
  async function callBillingPortal(){
    try{
      const { data: { session } } = await SB.auth.getSession();
      const u = session?.user;
      if(!u?.id){
        alert("Sessionen är ogiltig. Logga in igen.");
        return;
      }
      currentUser = u;
      await ensureProfileRow();
      const r = await fetch("/api/create-portal-session", {
        method:"POST",
        headers:{ "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: u?.id })
      });
      const d = await r.json();
      if(d?.url) location.href = d.url; else alert(d?.error || "Ingen portal hittades");
    }catch(e){ alert("Nätverksfel mot Stripe"); }
  }
  $("#upgradeBtn").onclick = callStripeCheckout;
  $("#manageBillingBtn").onclick = callBillingPortal;

  // ======= DATA =======
  async function loadProjects(){
    const { data, error } = await SB.from("projects")
      .select("id,name")
      .eq("user_id", currentUser.id)
      .order("created_at",{ascending:true});
    if(error){ console.error(error); return; }
    projects = data||[];
    renderProjectSelect();
  }

  function renderProjectSelect(){
    const sel = $("#projectSelect");
    if(!sel) return;
    sel.innerHTML = "";
    for(const p of projects){
      const opt = document.createElement("option");
      opt.value = p.id; opt.textContent = p.name;
      sel.appendChild(opt);
    }
    if(projects.length && !currentProject){
      currentProject = projects[0];
      sel.value = currentProject.id;
      loadBets();
    }else if(currentProject){
      sel.value = currentProject.id;
    }
    updateProjectMeta();
  }

  function updateProjectMeta(){
    const title = $("#projectTitle");
    if(title) title.textContent = currentProject?.name || "Inget projekt valt";
    const count = $("#projectCount");
    if(count) count.textContent = projects.length.toString();
  }

  $("#projectSelect").onchange = ()=>{
    const id = $("#projectSelect").value;
    currentProject = projects.find(p=>p.id===id) || null;
    loadBets();
  };

  $("#newProjectBtn").onclick = async ()=>{
    const name = prompt("Namn på nytt projekt:", "Nytt projekt");
    if(!name) return;
    const { data, error } = await SB.from("projects")
      .insert({ name, user_id: currentUser.id })
      .select("id,name")
      .single();
    if(error){ alert("Kunde inte skapa projekt"); return; }
    projects.push(data);
    currentProject = data;
    renderProjectSelect();
    await loadBets();
  };

  $("#renameProjectBtn").onclick = async ()=>{
    if(!currentProject) return;
    const name = prompt("Nytt namn:", currentProject.name);
    if(!name) return;
    const { error } = await SB.from("projects")
      .update({ name })
      .eq("id", currentProject.id)
      .eq("user_id", currentUser.id);
    if(error){ alert("Kunde inte byta namn"); return; }
    currentProject.name = name;
    renderProjectSelect();
  };

  $("#deleteProjectBtn").onclick = async ()=>{
    if(!currentProject) return;
    if(!confirm("Radera projektet och alla spel?")) return;
    const { error } = await SB.from("projects")
      .delete()
      .eq("id", currentProject.id)
      .eq("user_id", currentUser.id);
    if(error){ alert("Kunde inte radera"); return; }
    projects = projects.filter(p=>p.id!==currentProject.id);
    currentProject = projects[0] || null;
    renderProjectSelect();
    await loadBets();
  };

  $("#resetProjectBtn").onclick = async ()=>{
    if(!currentProject) return;
    if(!confirm("Ta bort alla spel i projektet?")) return;
    const { error } = await SB.from("bets")
      .delete()
      .eq("project_id", currentProject.id)
      .eq("user_id", currentUser.id);
    if(error){ alert("Kunde inte nollställa"); return; }
    await loadBets();
  };

  async function loadBets(){
    updateProjectMeta();
    const cont = $("#playsContainer");
    if(!currentProject){
      bets = [];
      if(cont) cont.innerHTML = '<div class="empty-state">Välj eller skapa ett projekt för att börja registrera spel.</div>';
      renderSummary();
      await updateFreeBanner();
      return;
    }
    const { data, error } = await SB.from("bets")
      .select("*")
      .eq("project_id", currentProject.id)
      .eq("user_id", currentUser.id)
      .order("matchday",{ascending:false})
      .order("created_at",{ascending:false});
    if(error){ console.error(error); return; }
    bets = data||[];
    renderBets();
    renderSummary();
    await updateFreeBanner();
  }

  async function updateFreeBanner(){
    if(!currentUser) return;
    try{
      const addBtn = $("#addBetBtn");
      const { data: profile, error: profileErr } = await SB
        .from("users")
        .select("is_premium")
        .eq("id", currentUser.id)
        .maybeSingle();
      if(profileErr) throw profileErr;
      if(!profile){
        await ensureProfileRow();
      }

      const premium = !!profile?.is_premium;
      if(premium){
        $("#freeBanner").classList.add("hide");
        $("#upgradeBtn").classList.add("hide");
        $("#manageBillingBtn").classList.remove("hide");
        if(addBtn) addBtn.disabled = false;
        return;
      }

      const { count, error: countErr } = await SB.from("bets")
        .select("id", { count: "exact", head: true })
        .eq("user_id", currentUser.id);
      if(countErr) throw countErr;

      const used = count || 0;
      const left = Math.max(0, 20 - used);
      $("#usedCount").textContent = used;
      $("#leftCount").textContent = left;
      $("#freeBanner").classList.toggle("hide", false);
      $("#upgradeBtn").classList.remove("hide");
      $("#manageBillingBtn").classList.add("hide");
      if(addBtn) addBtn.disabled = left <= 0;
    }catch(err){
      console.error("updateFreeBanner fel", err);
      $("#freeBanner").classList.add("hide");
      $("#upgradeBtn").classList.remove("hide");
      $("#manageBillingBtn").classList.add("hide");
      const addBtn = $("#addBetBtn");
      if(addBtn) addBtn.disabled = false;
    }
  }

  // ======= LÄGG TILL SPEL =======
  $("#addBetBtn").onclick = async ()=>{
    if(!currentProject) return alert("Välj/skapa projekt först.");
    const d = $("#iDate").value;
    const match = $("#iMatch").value.trim();
    const market = $("#iMarket").value.trim();
    const odds = parseFloat($("#iOdds").value);
    const stake = parseFloat($("#iStake").value||"1");
    const book = $("#iBook").value.trim();
    const result = $("#iResult").value;
    const note = $("#iNote").value.trim();

    if(!d || !match || !market || !odds || !stake) return alert("Fyll i alla fält.");

    if($("#addBetBtn").disabled){
      alert("Du har använt alla 20 gratis spel. Uppgradera för fler.");
      return;
    }

    const { error } = await SB.from("bets").insert({
      project_id: currentProject.id,
      user_id: currentUser.id,
      matchday: d,
      match, market, odds, stake, book, result, note
    });
    if(error){ alert("Kunde inte spara spel"); return; }

    $("#iNote").value = "";
    await loadBets();
    setTab("list");
  };

  // ======= RENDER LISTA (gruppera per månad) =======
  function renderBets(){
    const byMonth = {};
    for(const b of bets){
      if(!b.matchday) continue;
      const ym = b.matchday.slice(0,7); // YYYY-MM
      (byMonth[ym] ||= []).push(b);
    }
    const cont = $("#playsContainer");
    if(!cont) return;
    cont.innerHTML = "";

    if(!bets.length){
      cont.innerHTML = '<div class="empty-state">Inga spel registrerade ännu. Lägg till ditt första spel via formuläret till vänster.</div>';
      return;
    }

    const formatNumber = (value, decimals = 2) => {
      const num = Number(value);
      return Number.isFinite(num) ? num.toFixed(decimals) : "–";
    };
    const formatStake = value => {
      const num = Number(value);
      if(!Number.isFinite(num)) return "–";
      return Number.isInteger(num) ? num.toString() : num.toFixed(2);
    };

    Object.keys(byMonth).sort().reverse().forEach(ym=>{
      const arr = byMonth[ym];
      const [y,m] = ym.split("-").map(Number);
      const el = document.createElement("details");
      el.className = "month"; el.open = false;
      el.innerHTML = `<summary>${svMonth(y,m)}<span class="month-count">${arr.length} spel</span></summary>`;

      const header = document.createElement("div");
      header.className = "row row-head";
      header.innerHTML = `
        <div>Datum</div><div>Match &amp; Marknad</div><div>Odds</div>
        <div>Insats</div><div>Spelbolag</div><div>Notering</div><div>Resultat</div>`;
      el.appendChild(header);

      for(const b of arr){
        const row = document.createElement("div"); row.className="row";
        const matchInfo = `${b.match || "–"}`;
        const marketInfo = b.market ? `<span class="market">${b.market}</span>` : "";
        const book = b.book ? b.book : "–";
        const note = b.note ? b.note : "–";
        const resHtml = `
          <div class="actions">
            <span class="pill win" data-r="Win">Win</span>
            <span class="pill loss" data-r="Loss">Loss</span>
            <span class="pill pending" data-r="Pending">Pending</span>
            <span class="pill void" data-r="Void">Void</span>
            <span class="pill" data-del="1" style="margin-left:6px">Ta bort</span>
          </div>`;
        row.innerHTML = `
          <div data-label="Datum">${b.matchday || "–"}</div>
          <div data-label="Match &amp; Marknad" class="cell-match"><span class="match">${matchInfo}</span>${marketInfo}</div>
          <div data-label="Odds">${formatNumber(b.odds, 2)}</div>
          <div data-label="Insats">${formatStake(b.stake)}</div>
          <div data-label="Spelbolag">${book}</div>
          <div data-label="Notering" class="note-cell">${note}</div>
          <div data-label="Resultat">${resHtml}</div>
        `;
        row.querySelectorAll(".pill").forEach(p=>{
          p.onclick = async ()=>{
            if(p.dataset.del){
              if(confirm("Ta bort spelet?")){
                await SB.from("bets")
                  .delete()
                  .eq("id", b.id)
                  .eq("user_id", currentUser.id);
                await loadBets();
              }
            }else{
              await SB.from("bets")
                .update({ result: p.dataset.r })
                .eq("id", b.id)
                .eq("user_id", currentUser.id);
              await loadBets();
            }
          };
        });
        el.appendChild(row);
      }
      cont.appendChild(el);
    });
  }

  function renderQuickStats(){
    const totalEl = $("#quickTotal");
    if(!totalEl) return;
    const total = bets.length;
    const pending = bets.filter(b => b.result === "Pending").length;
    const decided = bets.filter(b => b.result !== "Pending" && b.result !== "Void");
    const wins = decided.filter(b => b.result === "Win").length;
    const profit = bets.reduce((sum, b) => {
      const stakeNum = Number(b.stake);
      if(!Number.isFinite(stakeNum)) return sum;
      if(b.result === "Win"){
        const oddsNum = Number(b.odds);
        return Number.isFinite(oddsNum) ? sum + (oddsNum - 1) * stakeNum : sum;
      }
      if(b.result === "Loss"){
        return sum - stakeNum;
      }
      return sum;
    }, 0);

    totalEl.textContent = total.toString();
    const pendingEl = $("#quickPending");
    if(pendingEl) pendingEl.textContent = pending.toString();
    const winRateEl = $("#quickWinRate");
    if(winRateEl){
      if(decided.length){
        const rate = Math.round((wins / decided.length) * 1000) / 10;
        winRateEl.textContent = `${rate.toFixed(1)}%`;
      }else{
        winRateEl.textContent = "–";
      }
    }
    const profitEl = $("#quickProfit");
    if(profitEl) profitEl.textContent = fmtMoney(profit);
  }

  function recompute(monthFilter="all"){
    let data = bets;
    if(monthFilter!=="all"){
      data = data.filter(b => b.matchday?.startsWith(monthFilter));
    }
    const decided = data.filter(b => b.result!=="Pending" && b.result!=="Void");
    const wins = decided.filter(b => b.result==="Win").length;
    const stakeSum = decided.reduce((s,b)=>{
      const stakeNum = Number(b.stake);
      return Number.isFinite(stakeNum) ? s + stakeNum : s;
    },0);
    const profit = decided.reduce((s,b)=>{
      const stakeNum = Number(b.stake);
      if(!Number.isFinite(stakeNum)) return s;
      if(b.result==="Win"){
        const oddsNum = Number(b.odds);
        return Number.isFinite(oddsNum) ? s + (oddsNum-1)*stakeNum : s;
      }
      if(b.result==="Loss"){
        return s - stakeNum;
      }
      return s;
    }, 0);
    const roi = stakeSum>0 ? (profit/stakeSum)*100 : 0;

    $("#sGames").textContent = decided.length.toString();
    $("#sWins").textContent = wins.toString();
    $("#sProfit").textContent = fmtMoney(profit);
    $("#sRoi").textContent = fmtMoney(roi)+"%";

    if(monthFilter==="all"){ $("#sMonthName").textContent = "Alla månader"; }
    else{
      const [y,m] = monthFilter.split("-").map(Number);
      $("#sMonthName").textContent = svMonth(y,m);
    }
  }

  function renderSummary(){
    const months = [...new Set(bets.filter(b=>b.matchday).map(b=>b.matchday.slice(0,7)))].sort().reverse();
    const sel = $("#monthFilter");
    if(!sel) return;
    sel.innerHTML = `<option value="all">Alla månader</option>` + months.map(m=>`<option value="${m}">${m}</option>`).join("");
    sel.onchange = ()=>recompute(sel.value);
    recompute(sel.value||"all");
    renderQuickStats();
  }

  // ======= INIT =======
  (async function init(){
    try{
      await ensureAuth();
    }catch(err){
      console.warn("Användaren är inte inloggad", err);
      return;
    }

    $("#iDate").valueAsDate = new Date();
 main

</body>
</html>
