<!DOCTYPE html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BetSpread – App</title>
<link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin>
<style>
  :root{
    --bg:#050b17;
    --panel:rgba(12,22,39,0.92);
    --panel-strong:rgba(17,31,52,0.95);
    --muted:rgba(22,34,54,0.8);
    --text:#f1f5ff;
    --sub:#8ca3cc;
    --accent:#60a5fa;
    --accent-2:#4ade80;
    --danger:#ef4444;
    --btn:rgba(42,60,100,0.9);
    --btn-h:rgba(58,82,134,0.95);
    --tab:rgba(20,33,54,0.6);
    --tab-a:rgba(47,85,151,0.82);
    --shadow:0 28px 65px -35px rgba(7,11,24,0.9);
    --radius:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    background:linear-gradient(180deg,#040914,#0d1729);
    color:var(--text);
    font:16px/1.5 "Inter","Segoe UI",-apple-system,BlinkMacSystemFont,"Helvetica Neue",Arial,sans-serif;
    position:relative;
  }
  body::before{
    content:"";
    position:fixed;
    inset:0;
    background:radial-gradient(50% 60% at 18% 14%,rgba(96,165,250,0.22) 0%,rgba(5,11,23,0) 100%),
      radial-gradient(55% 65% at 80% 12%,rgba(99,102,241,0.18) 0%,rgba(5,11,23,0) 100%);
    pointer-events:none;
    z-index:-1;
  }
  .container{
    width:100%;
    max-width:1220px;
    margin:0 auto;
    padding:36px 22px 64px;
  }
  header.top-bar{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:24px;
    margin-bottom:24px;
    padding:22px 26px;
    border-radius:var(--radius);
    background:var(--panel-strong);
    border:1px solid rgba(74,96,138,0.38);
    box-shadow:var(--shadow);
    backdrop-filter:blur(12px);
  }
  .brand-block{display:flex;flex-direction:column;gap:6px}
  .brand{
    font-weight:800;
    font-size:28px;
    letter-spacing:.02em;
    background:linear-gradient(135deg,#a855f7,#38bdf8);
    -webkit-background-clip:text;
    color:transparent;
  }
  .tagline{margin:0;font-size:14px;color:var(--sub)}
  .right-actions{display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  button,.btn{
    background:var(--btn);
    border:1px solid rgba(96,119,173,0.45);
    color:var(--text);
    border-radius:12px;
    padding:10px 16px;
    cursor:pointer;
    transition:background .2s ease,transform .2s ease,border-color .2s ease;
    font-weight:600;
    letter-spacing:.01em;
  }
  button:hover,.btn:hover{background:var(--btn-h);transform:translateY(-1px);}
  button:focus-visible,.btn:focus-visible{outline:2px solid var(--accent);outline-offset:3px;}
  .btn-green{background:linear-gradient(135deg,#34d399,#10b981);border:none;box-shadow:0 12px 32px -20px rgba(16,185,129,0.7);}
  .btn-green:hover{filter:brightness(1.05);}
  .btn-red{background:linear-gradient(135deg,#f87171,#ef4444);border:none;box-shadow:0 12px 32px -20px rgba(239,68,68,0.65);}
  .btn-red:hover{filter:brightness(1.05);}
  .btn-ghost{background:rgba(18,30,52,0.7);border:1px solid rgba(78,106,150,0.45);}
  .btn-ghost:hover{background:rgba(34,52,86,0.8);}
  .badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:6px 14px;
    border-radius:999px;
    background:rgba(59,130,246,0.12);
    border:1px solid rgba(96,165,250,0.35);
    color:var(--accent);
    font-weight:600;
    font-size:14px;
  }
  .banner{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:18px;
    padding:18px 22px;
    margin-bottom:24px;
    border-radius:var(--radius);
    background:linear-gradient(135deg,rgba(248,113,113,0.2),rgba(248,113,113,0.08));
    border:1px solid rgba(248,113,113,0.45);
    color:#ffe1e1;
    box-shadow:0 18px 45px -30px rgba(248,113,113,0.45);
  }
  .banner h2{margin:0 0 4px;font-size:18px;color:#ffe1e1;}
  .banner p{margin:0;font-size:15px;color:#ffd9d9;line-height:1.45;}
  .workspace{
    display:grid;
    grid-template-columns:minmax(0,1fr) 320px;
    gap:24px;
    align-items:flex-start;
  }
  .primary,.secondary{display:flex;flex-direction:column;gap:24px;}
  .project-bar{
    display:flex;
    align-items:flex-end;
    justify-content:space-between;
    gap:18px;
    padding:18px 22px;
    border-radius:var(--radius);
    background:var(--panel-strong);
    border:1px solid rgba(74,96,138,0.38);
    box-shadow:var(--shadow);
    backdrop-filter:blur(12px);
  }
  .project-bar .project-summary{display:flex;flex-direction:column;gap:4px;min-width:160px;}
  .project-bar .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .project-bar .value{font-size:18px;font-weight:600;}
  .project-bar .project-picker{display:flex;align-items:center;gap:10px;flex-wrap:wrap;flex:1;}
  .project-bar select{min-width:200px;}
  .project-bar button{padding:8px 14px;font-size:14px;}
  .project-count{display:flex;flex-direction:column;align-items:flex-end;gap:4px;min-width:90px;}
  .panel{
    background:var(--panel);
    border:1px solid rgba(74,96,138,0.38);
    border-radius:var(--radius);
    padding:24px;
    box-shadow:var(--shadow);
    backdrop-filter:blur(12px);
  }
  .panel h2{margin:0;font-size:20px;font-weight:700;letter-spacing:.01em;}
  .hint{color:var(--sub);font-size:14px;}
  .subtle{color:var(--sub);font-size:13px;}
  .section-header{
    display:flex;
    align-items:flex-start;
    justify-content:space-between;
    gap:20px;
    margin-bottom:20px;
  }
  select,input,textarea{
    background:rgba(10,20,35,0.85);
    border:1px solid rgba(78,106,150,0.4);
    color:var(--text);
    padding:12px 14px;
    border-radius:12px;
    font-size:15px;
    transition:border .2s ease,box-shadow .2s ease,background .2s ease;
  }
  select:focus-visible,input:focus-visible,textarea:focus-visible{
    border-color:rgba(96,165,250,0.8);
    box-shadow:0 0 0 3px rgba(96,165,250,0.2);
    outline:none;
  }
  textarea{resize:vertical;min-height:96px;}
  .tabs{
    display:flex;
    gap:12px;
    padding:6px;
    background:rgba(15,26,44,0.7);
    border:1px solid rgba(72,95,142,0.35);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
  }
  .tab{
    flex:1;
    padding:12px 16px;
    border-radius:12px;
    border:1px solid transparent;
    background:transparent;
    color:var(--sub);
    font-weight:600;
    letter-spacing:.02em;
    cursor:pointer;
    transition:background .2s ease,color .2s ease,border .2s ease,transform .2s ease;
  }
  .tab:hover{color:var(--text);transform:translateY(-1px);}
  .tab.active{
    background:linear-gradient(135deg,rgba(96,165,250,0.28),rgba(56,189,248,0.16));
    border-color:rgba(96,165,250,0.5);
    color:var(--text);
    box-shadow:0 12px 28px -20px rgba(96,165,250,0.7);
  }
  .grid{
    display:grid;
    grid-template-columns:repeat(12,minmax(0,1fr));
    gap:16px;
  }
  .grid .field{display:flex;flex-direction:column;gap:6px;}
  .grid label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .col-1{grid-column:span 1;}
  .col-2{grid-column:span 2;}
  .col-3{grid-column:span 3;}
  .col-4{grid-column:span 4;}
  .col-5{grid-column:span 5;}
  .col-6{grid-column:span 6;}
  .col-12{grid-column:span 12;}
  .actions{display:flex;flex-wrap:wrap;gap:12px;align-items:center;}
  .action-field{align-self:end;}
  .sr-only{
    position:absolute;
    width:1px;
    height:1px;
    padding:0;
    margin:-1px;
    overflow:hidden;
    clip:rect(0,0,0,0);
    white-space:nowrap;
    border:0;
  }
  .summary-panel .filter{display:flex;flex-direction:column;gap:8px;min-width:190px;}
  .summary-panel select{min-width:190px;}
  .stat-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
    gap:16px;
  }
  .stat-card{
    padding:18px;
    border-radius:14px;
    background:rgba(18,32,54,0.8);
    border:1px solid rgba(73,103,152,0.4);
    display:flex;
    flex-direction:column;
    gap:6px;
  }
  .stat-card .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .stat-card .value{font-size:26px;font-weight:700;}
  .trend-card{
    margin-top:20px;
    padding:18px;
    border-radius:14px;
    background:rgba(22,36,58,0.8);
    border:1px solid rgba(72,103,152,0.35);
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .trend-card .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .trend-card .value{font-size:18px;font-weight:600;}
  #playsContainer{display:flex;flex-direction:column;gap:16px;}
  details.month{
    border-radius:var(--radius);
    border:1px solid rgba(72,103,152,0.35);
    background:rgba(17,29,49,0.75);
    overflow:hidden;
    box-shadow:var(--shadow);
  }
  details.month summary{
    list-style:none;
    padding:18px 22px;
    font-weight:700;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    cursor:pointer;
    background:linear-gradient(135deg,rgba(96,165,250,0.2),rgba(56,189,248,0.08));
  }
  details.month summary::-webkit-details-marker{display:none;}
  details.month[open] summary{border-bottom:1px solid rgba(72,103,152,0.35);background:linear-gradient(135deg,rgba(96,165,250,0.08),rgba(56,189,248,0.05));}
  .month-count{font-size:14px;color:var(--sub);}
  .row{
    display:grid;
    grid-template-columns:120px 1.8fr 90px 90px 150px 220px;
    gap:16px;
    padding:16px 22px;
    align-items:flex-start;
  }
  .row-head{
    background:rgba(255,255,255,0.02);
    font-size:12px;
    letter-spacing:.08em;
    text-transform:uppercase;
    color:var(--sub);
    font-weight:600;
    padding-top:14px;
    padding-bottom:14px;
  }
  .row:not(.row-head):nth-child(odd){background:rgba(10,18,32,0.3);}
  .row > div{min-width:0;}
  .cell-match .match{font-weight:600;display:block;}
  .cell-match .market{display:block;font-size:13px;color:var(--sub);margin-top:2px;}
  .result-cell{display:flex;align-items:center;gap:12px;justify-content:flex-start;flex-wrap:wrap;}
  .status-badge{
    padding:6px 12px;
    border-radius:999px;
    font-size:13px;
    font-weight:600;
    letter-spacing:.01em;
    border:1px solid transparent;
  }
  .status-badge.win{background:rgba(22,101,52,0.28);border-color:rgba(134,239,172,0.45);color:#86efac;}
  .status-badge.loss{background:rgba(153,27,27,0.28);border-color:rgba(248,113,113,0.5);color:#fca5a5;}
  .status-badge.pending{background:rgba(30,64,175,0.25);border-color:rgba(129,140,248,0.45);color:#c7d2fe;}
  .status-badge.void{background:rgba(107,114,128,0.25);border-color:rgba(156,163,175,0.45);color:#e5e7eb;}
  .action-dropdown{position:relative;}
  .dropdown-toggle{
    background:var(--btn);
    border:1px solid rgba(96,119,173,0.45);
    color:var(--text);
    border-radius:10px;
    padding:8px 12px;
    font-weight:600;
    cursor:pointer;
    font-size:13px;
    transition:background .2s ease,border .2s ease,transform .2s ease;
  }
  .dropdown-toggle:hover{background:var(--btn-h);transform:translateY(-1px);}
  .action-dropdown.open .dropdown-toggle{border-color:rgba(96,165,250,0.7);}
  .action-menu{position:absolute;top:calc(100% + 8px);right:0;min-width:210px;display:none;flex-direction:column;padding:10px;background:rgba(10,18,32,0.95);border:1px solid rgba(78,106,150,0.45);border-radius:12px;box-shadow:0 18px 45px -20px rgba(8,12,28,0.85);z-index:10;}
  .action-dropdown.open .action-menu{display:flex;}
  .action-menu button{
    background:transparent;
    border:none;
    color:var(--text);
    text-align:left;
    padding:10px 12px;
    border-radius:8px;
    font-size:14px;
    font-weight:500;
    cursor:pointer;
    transition:background .2s ease,color .2s ease;
  }
  .action-menu button:focus-visible{outline:2px solid var(--accent);outline-offset:2px;}
  .action-menu button:hover{background:rgba(45,70,110,0.6);color:#fff;}
  .action-menu button[data-action="delete"]{color:#fca5a5;}
  .action-menu button[data-action="delete"]:hover{background:rgba(120,31,46,0.35);}
  .empty-state{
    padding:32px 24px;
    text-align:center;
    background:rgba(17,31,52,0.75);
    border:1px dashed rgba(99,102,241,0.35);
    border-radius:var(--radius);
    color:var(--sub);
    font-size:15px;
    line-height:1.6;
  }
  .highlight-panel{position:sticky;top:24px;}
  .overview-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
    gap:16px;
    margin-top:18px;
  }
  .overview-card{
    padding:16px;
    border-radius:14px;
    background:rgba(18,32,54,0.72);
    border:1px solid rgba(72,103,152,0.35);
    display:flex;
    flex-direction:column;
    gap:6px;
    transition:transform .2s ease,border .2s ease,background .2s ease;
  }
  .overview-card:hover{transform:translateY(-2px);border-color:rgba(96,165,250,0.5);background:rgba(21,38,62,0.8);}
  .overview-card .label{font-size:12px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);}
  .overview-card .value{font-size:24px;font-weight:700;}
  .hide{display:none!important;}
  @media (max-width:1100px){
    .workspace{grid-template-columns:1fr;}
    .secondary{flex-direction:row;flex-wrap:wrap;}
    .highlight-panel{position:static;}
    .row{grid-template-columns:110px 1.6fr 80px 80px 130px 200px;}
    .grid{grid-template-columns:repeat(6,minmax(0,1fr));}
    .col-1,.col-2{grid-column:span 3;}
    .col-3{grid-column:span 3;}
    .col-4,.col-6{grid-column:span 6;}
  }
  @media (max-width:900px){
    .row-head{display:none;}
    .row{grid-template-columns:repeat(2,minmax(0,1fr));padding:14px 18px;border-bottom:1px solid rgba(72,103,152,0.25);}
    .row:not(.row-head) > div{display:flex;flex-direction:column;gap:4px;}
    .row:not(.row-head) > div::before{content:attr(data-label);font-size:11px;text-transform:uppercase;letter-spacing:.08em;color:var(--sub);font-weight:600;}
    .result-cell{align-items:flex-start;}
  }
  @media (max-width:760px){
    .secondary{flex-direction:column;}
  }
  @media (max-width:720px){
    .grid{grid-template-columns:repeat(1,minmax(0,1fr));}
    .col-1,.col-2,.col-3,.col-4,.col-6,.col-12{grid-column:span 1;}
    .action-field{align-self:auto;}
    .actions{flex-direction:column;align-items:stretch;}
    .tabs{flex-direction:column;}
  }
  @media (max-width:640px){
    header.top-bar{flex-direction:column;align-items:flex-start;}
    .right-actions{justify-content:flex-start;width:100%;}
    .project-bar{flex-direction:column;align-items:flex-start;}
    .project-count{align-items:flex-start;}
    .project-bar .project-picker{width:100%;justify-content:flex-start;}
    .project-bar .project-picker select{flex:1;min-width:0;}
  }
  @media (max-width:480px){
    .right-actions{gap:10px;}
    .right-actions button{width:100%;}
    .badge{width:100%;justify-content:center;}
    .banner{flex-direction:column;align-items:flex-start;}
  }
</style>
</head>
<body>
  <div class="container">
    <header class="top-bar">
      <div class="brand-block">
        <div class="brand">BetSpread</div>
        <p class="tagline">Planera, följ upp och förbättra dina spel.</p>
      </div>
      <div class="right-actions">
        <span id="userEmail" class="badge">…</span>
        <button id="manageBillingBtn" title="Hantera abonnemang" class="hide">Hantera</button>
        <button id="upgradeBtn" class="btn-green">Uppgradera</button>
        <button id="logoutBtn" class="btn-red">Logga ut</button>
      </div>
    </header>

    <div id="freeBanner" class="banner hide">
      <div>
        <h2>Gratisläge</h2>
        <p>Du har använt <strong id="usedCount">0</strong> av 20 spel. <br>Återstår: <strong id="leftCount">20</strong> spel.</p>
      </div>
      <span class="hint">Uppgradera för obegränsade registreringar.</span>
    </div>

    <main class="workspace">
      <section class="primary">
        <div class="project-bar">
          <div class="project-summary">
            <span class="label">Aktivt projekt</span>
            <span id="projectTitle" class="value">Inget projekt valt</span>
          </div>
          <div class="project-picker">
            <label for="projectSelect" class="sr-only">Välj projekt</label>
            <select id="projectSelect"></select>
            <button id="newProjectBtn">Nytt projekt</button>
            <button id="renameProjectBtn">Byt namn</button>
            <button id="deleteProjectBtn" class="btn-red">Radera</button>
          </div>
          <div class="project-count">
            <span class="label">Projekt</span>
            <span class="value" id="projectCount">0</span>
          </div>
        </div>

        <nav class="tabs" role="tablist">
          <button type="button" id="tab-reg-btn" class="tab active" data-tab="reg" role="tab" aria-controls="tab-reg" aria-selected="true">Registrera spel</button>
          <button type="button" id="tab-summary-btn" class="tab" data-tab="summary" role="tab" aria-controls="tab-summary" aria-selected="false">Månadssummering</button>
          <button type="button" id="tab-list-btn" class="tab" data-tab="list" role="tab" aria-controls="tab-list" aria-selected="false">Spel</button>
        </nav>

        <section id="tab-reg" class="panel form-panel" role="tabpanel" aria-labelledby="tab-reg-btn" aria-hidden="false">
          <div class="section-header">
            <div>
              <h2>Registrera spel</h2>
              <p class="hint">Fyll i matchinformationen och klicka på &quot;Lägg till spel&quot; för att spara.</p>
            </div>
          </div>
          <div class="grid">
            <div class="col-2 field">
              <label for="iDate">Matchdag</label>
              <input id="iDate" type="date" />
            </div>
            <div class="col-3 field">
              <label for="iMatch">Match</label>
              <input id="iMatch" type="text" placeholder="Arsenal — Chelsea" />
            </div>
            <div class="col-3 field">
              <label for="iMarket">Marknad</label>
              <input id="iMarket" type="text" placeholder="Över 8.5 frisparkar" />
            </div>
            <div class="col-2 field">
              <label for="iOdds">Oddset</label>
              <input id="iOdds" type="number" step="0.01" min="1.01" placeholder="1.85" />
            </div>
            <div class="col-1 field">
              <label for="iStake">Insats</label>
              <input id="iStake" type="number" step="1" min="1" value="1" />
            </div>
            <div class="col-1 field">
              <label for="iBook">Spelbolag</label>
              <input id="iBook" type="text" placeholder="Bet365" />
            </div>
            <div class="col-2 field">
              <label for="iResult">Resultat</label>
              <select id="iResult">
                <option>Pending</option>
                <option>Win</option>
                <option>Loss</option>
                <option>Void</option>
              </select>
            </div>
            <div class="col-4 field action-field">
              <span class="sr-only">Åtgärder</span>
              <div class="actions">
                <button id="addBetBtn" class="btn-green">Lägg till spel</button>
                <button id="cancelEditBtn" class="btn btn-ghost hide">Avbryt redigering</button>
                <button id="resetProjectBtn" class="btn-red">Nollställ projekt</button>
              </div>
            </div>
          </div>
        </section>

        <section id="tab-summary" class="panel summary-panel hide" role="tabpanel" aria-labelledby="tab-summary-btn" aria-hidden="true">
          <div class="section-header">
            <div>
              <h2>Månadssummering</h2>
              <p class="hint">Analysera avgjorda spel och följ ROI per månad.</p>
            </div>
            <div class="filter">
              <label for="monthFilter">Månad (matchdag)</label>
              <select id="monthFilter"></select>
            </div>
          </div>
          <div class="stat-grid">
            <div class="stat-card"><span class="label">Spel (avgjorda)</span><span id="sGames" class="value">0</span></div>
            <div class="stat-card"><span class="label">Vinster</span><span id="sWins" class="value">0</span></div>
            <div class="stat-card"><span class="label">Profit</span><span id="sProfit" class="value">0.00</span></div>
            <div class="stat-card"><span class="label">ROI</span><span id="sRoi" class="value">0.00%</span></div>
          </div>
          <div class="trend-card">
            <span class="label">Visar</span>
            <span id="sMonthName" class="value">-</span>
          </div>
        </section>

        <section id="tab-list" class="panel list-panel hide" role="tabpanel" aria-labelledby="tab-list-btn" aria-hidden="true">
          <div class="section-header">
            <div>
              <h2>Spel</h2>
              <p class="hint">Hantera registrerade spel och uppdatera resultaten.</p>
            </div>
          </div>
          <div id="playsContainer"></div>
        </section>
      </section>

      <aside class="secondary">
        <section class="panel highlight-panel">
          <h2>Snabböversikt</h2>
          <div class="overview-grid">
            <div class="overview-card"><span class="label">Spel totalt</span><span id="quickTotal" class="value">0</span></div>
            <div class="overview-card"><span class="label">Pågående</span><span id="quickPending" class="value">0</span></div>
            <div class="overview-card"><span class="label">ROI</span><span id="quickRoi" class="value">–</span></div>
            <div class="overview-card"><span class="label">Profit</span><span id="quickProfit" class="value">0.00</span></div>
          </div>
        </section>
      </aside>
    </main>
  </div>

<script type="module">
  // --- Konfiguration ---
  const SUPABASE_URL = "https://updpywjfxeahtjpelbku.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwZHB5d2pmeGVhaHRqcGVsYmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MjQzOTcsImV4cCI6MjA3MjUwMDM5N30.i1ztG8dkcHFLq8WEn_uVrgCBk0_Wf5gZb_OQQuaSGgo";

  // --- Bibliotek ---
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm";
  const SB = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // --- Tillstånd ---
  let currentUser = null;
  let currentProject = null; // {id, name}
  let projects = []; // [{id,name}]
  let bets = [];     // alla bets för valt projekt
  let editingBetId = null;

  // --- UI-hjälpare ---
  const $ = s => document.querySelector(s);
  const $$ = s => document.querySelectorAll(s);
  const fmtMoney = v => (Math.round(v * 100)/100).toFixed(2);
  const svMonth = (y,m) => new Date(y, m-1, 1).toLocaleDateString("sv-SE",{month:"long",year:"numeric"});

  function setTab(name){
    $$(".tab").forEach(t => {
      const active = t.dataset.tab === name;
      t.classList.toggle("active", active);
      t.setAttribute("aria-selected", active ? "true" : "false");
    });
    const reg = $("#tab-reg");
    const summary = $("#tab-summary");
    const list = $("#tab-list");
    if(reg){ reg.classList.toggle("hide", name!=="reg"); reg.setAttribute("aria-hidden", name!=="reg"); }
    if(summary){ summary.classList.toggle("hide", name!=="summary"); summary.setAttribute("aria-hidden", name!=="summary"); }
    if(list){ list.classList.toggle("hide", name!=="list"); list.setAttribute("aria-hidden", name!=="list"); }
  }

  $$(".tab").forEach(t => t.addEventListener("click",()=>setTab(t.dataset.tab)));

  function closeActionMenus(){
    document.querySelectorAll(".action-dropdown.open").forEach(el => {
      el.classList.remove("open");
      const toggle = el.querySelector(".dropdown-toggle");
      if(toggle){
        toggle.setAttribute("aria-expanded", "false");
      }
    });
    document
      .querySelectorAll('.dropdown-toggle[aria-expanded="true"]')
      .forEach(btn => btn.setAttribute("aria-expanded", "false"));
  }

  function resetBetForm(){
    const today = new Date();
    today.setHours(0,0,0,0);
    const dateInput = $("#iDate");
    if(dateInput) dateInput.valueAsDate = today;
    const matchInput = $("#iMatch");
    if(matchInput) matchInput.value = "";
    const marketInput = $("#iMarket");
    if(marketInput) marketInput.value = "";
    const oddsInput = $("#iOdds");
    if(oddsInput) oddsInput.value = "";
    const stakeInput = $("#iStake");
    if(stakeInput) stakeInput.value = "1";
    const bookInput = $("#iBook");
    if(bookInput) bookInput.value = "";
    const resultSelect = $("#iResult");
    if(resultSelect) resultSelect.value = "Pending";
    editingBetId = null;
    const addBtn = $("#addBetBtn");
    if(addBtn) addBtn.textContent = "Lägg till spel";
    const cancelBtn = $("#cancelEditBtn");
    if(cancelBtn) cancelBtn.classList.add("hide");
  }

  function startEdit(bet){
    editingBetId = bet.id;
    const dateInput = $("#iDate");
    if(dateInput) dateInput.value = bet.matchday ? bet.matchday.slice(0,10) : "";
    const matchInput = $("#iMatch");
    if(matchInput) matchInput.value = bet.match || "";
    const marketInput = $("#iMarket");
    if(marketInput) marketInput.value = bet.market || "";
    const oddsInput = $("#iOdds");
    if(oddsInput){
      const oddsNum = parseFloat(bet.odds);
      oddsInput.value = Number.isFinite(oddsNum) ? oddsNum : "";
    }
    const stakeInput = $("#iStake");
    if(stakeInput){
      const stakeNum = parseFloat(bet.stake);
      stakeInput.value = Number.isFinite(stakeNum) ? stakeNum : "1";
    }
    const bookInput = $("#iBook");
    if(bookInput) bookInput.value = bet.book || "";
    const resultSelect = $("#iResult");
    if(resultSelect) resultSelect.value = bet.result || "Pending";
    const addBtn = $("#addBetBtn");
    if(addBtn) addBtn.textContent = "Spara spel";
    const cancelBtn = $("#cancelEditBtn");
    if(cancelBtn) cancelBtn.classList.remove("hide");
    setTab("reg");
    closeActionMenus();
  }

  document.addEventListener("click", closeActionMenus);
  document.addEventListener("keydown", ev => {
    if(ev.key === "Escape"){
      closeActionMenus();
    }
  });

  // --- Auth ---
  async function ensureProfileRow(){
    if(!currentUser) return;
    try{
      const payload = { id: currentUser.id };
      if(currentUser.email) payload.email = currentUser.email;
      const { error } = await SB.from("users").upsert(payload, { onConflict: "id" });
      if(error) console.error("Kunde inte skapa/uppdatera användarrad", error);
    }catch(err){
      console.error("ensureProfileRow fel", err);
    }
  }

  async function ensureAuth(){
    const { data: { session } } = await SB.auth.getSession();
    if(!session){
      location.href = "/login.html";
      throw new Error("NOT_AUTHENTICATED");
    }
    currentUser = session.user;
    $("#userEmail").textContent = currentUser.email || "Ingen e-post";
    await ensureProfileRow();
  }

  $("#logoutBtn").onclick = async () => { await SB.auth.signOut(); location.href="/"; };

  // --- Stripe-knappar ---
  async function callStripeCheckout(){
    try{
      const { data: { session } } = await SB.auth.getSession();
      const u = session?.user;
      if(!u?.id){
        alert("Sessionen är ogiltig. Logga in igen.");
        return;
      }
      currentUser = u;
      await ensureProfileRow();
      const r = await fetch("/api/create-checkout-session", {
        method:"POST",
        headers:{ "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: u?.id, email: u?.email })
      });
      const d = await r.json();
      if(d?.url) location.href = d.url; else alert(d?.error || "Kunde inte starta Stripe Checkout");
    }catch(e){ alert("Nätverksfel mot Stripe"); }
  }
  async function callBillingPortal(){
    try{
      const { data: { session } } = await SB.auth.getSession();
      const u = session?.user;
      if(!u?.id){
        alert("Sessionen är ogiltig. Logga in igen.");
        return;
      }
      currentUser = u;
      await ensureProfileRow();
      const r = await fetch("/api/create-portal-session", {
        method:"POST",
        headers:{ "Content-Type": "application/json" },
        body: JSON.stringify({ user_id: u?.id })
      });
      const d = await r.json();
      if(d?.url) location.href = d.url; else alert(d?.error || "Ingen portal hittades");
    }catch(e){ alert("Nätverksfel mot Stripe"); }
  }
  $("#upgradeBtn").onclick = callStripeCheckout;
  $("#manageBillingBtn").onclick = callBillingPortal;

  // --- Datahämtning ---
  async function loadProjects(){
    const { data, error } = await SB.from("projects")
      .select("id,name")
      .eq("user_id", currentUser.id)
      .order("created_at",{ascending:true});
    if(error){ console.error(error); return; }
    projects = data||[];
    renderProjectSelect();
  }

  function renderProjectSelect(){
    const sel = $("#projectSelect");
    if(!sel) return;
    sel.innerHTML = "";
    for(const p of projects){
      const opt = document.createElement("option");
      opt.value = p.id; opt.textContent = p.name;
      sel.appendChild(opt);
    }
    if(projects.length && !currentProject){
      currentProject = projects[0];
      sel.value = currentProject.id;
      loadBets();
    }else if(currentProject){
      sel.value = currentProject.id;
    }
    updateProjectMeta();
  }

  function updateProjectMeta(){
    const title = $("#projectTitle");
    if(title) title.textContent = currentProject?.name || "Inget projekt valt";
    const count = $("#projectCount");
    if(count) count.textContent = projects.length.toString();
  }

  $("#projectSelect").onchange = ()=>{
    const id = $("#projectSelect").value;
    currentProject = projects.find(p=>p.id===id) || null;
    loadBets();
  };

  $("#newProjectBtn").onclick = async ()=>{
    const name = prompt("Namn på nytt projekt:", "Nytt projekt");
    if(!name) return;
    const { data, error } = await SB.from("projects")
      .insert({ name, user_id: currentUser.id })
      .select("id,name")
      .single();
    if(error){ alert("Kunde inte skapa projekt"); return; }
    projects.push(data);
    currentProject = data;
    renderProjectSelect();
    await loadBets();
  };

  $("#renameProjectBtn").onclick = async ()=>{
    if(!currentProject) return;
    const name = prompt("Nytt namn:", currentProject.name);
    if(!name) return;
    const { error } = await SB.from("projects")
      .update({ name })
      .eq("id", currentProject.id)
      .eq("user_id", currentUser.id);
    if(error){ alert("Kunde inte byta namn"); return; }
    currentProject.name = name;
    renderProjectSelect();
  };

  $("#deleteProjectBtn").onclick = async ()=>{
    if(!currentProject) return;
    if(!confirm("Radera projektet och alla spel?")) return;
    const { error } = await SB.from("projects")
      .delete()
      .eq("id", currentProject.id)
      .eq("user_id", currentUser.id);
    if(error){ alert("Kunde inte radera"); return; }
    projects = projects.filter(p=>p.id!==currentProject.id);
    currentProject = projects[0] || null;
    renderProjectSelect();
    await loadBets();
  };

  $("#cancelEditBtn").onclick = ()=> resetBetForm();

  $("#resetProjectBtn").onclick = async ()=>{
    if(!currentProject) return;
    if(!confirm("Ta bort alla spel i projektet?")) return;
    const { error } = await SB.from("bets")
      .delete()
      .eq("project_id", currentProject.id)
      .eq("user_id", currentUser.id);
    if(error){ alert("Kunde inte nollställa"); return; }
    await loadBets();
  };

  async function loadBets(){
    closeActionMenus();
    resetBetForm();
    updateProjectMeta();
    const cont = $("#playsContainer");
    if(!currentProject){
      bets = [];
      if(cont) cont.innerHTML = '<div class="empty-state">Välj eller skapa ett projekt för att börja registrera spel.</div>';
      renderSummary();
      await updateFreeBanner();
      return;
    }
    const { data, error } = await SB.from("bets")
      .select("*")
      .eq("project_id", currentProject.id)
      .eq("user_id", currentUser.id)
      .order("matchday",{ascending:false})
      .order("created_at",{ascending:false});
    if(error){ console.error(error); return; }
    bets = data||[];
    renderBets();
    renderSummary();
    await updateFreeBanner();
  }

  async function updateFreeBanner(){
    if(!currentUser) return;
    try{
      const addBtn = $("#addBetBtn");
      const { data: profile, error: profileErr } = await SB
        .from("users")
        .select("is_premium")
        .eq("id", currentUser.id)
        .maybeSingle();
      if(profileErr) throw profileErr;
      if(!profile){
        await ensureProfileRow();
      }

      const premium = !!profile?.is_premium;
      if(premium){
        $("#freeBanner").classList.add("hide");
        $("#upgradeBtn").classList.add("hide");
        $("#manageBillingBtn").classList.remove("hide");
        if(addBtn) addBtn.disabled = false;
        return;
      }

      const { count, error: countErr } = await SB.from("bets")
        .select("id", { count: "exact", head: true })
        .eq("user_id", currentUser.id);
      if(countErr) throw countErr;

      const used = count || 0;
      const left = Math.max(0, 20 - used);
      $("#usedCount").textContent = used;
      $("#leftCount").textContent = left;
      $("#freeBanner").classList.toggle("hide", false);
      $("#upgradeBtn").classList.remove("hide");
      $("#manageBillingBtn").classList.add("hide");
      if(addBtn) addBtn.disabled = left <= 0;
    }catch(err){
      console.error("updateFreeBanner fel", err);
      $("#freeBanner").classList.add("hide");
      $("#upgradeBtn").classList.remove("hide");
      $("#manageBillingBtn").classList.add("hide");
      const addBtn = $("#addBetBtn");
      if(addBtn) addBtn.disabled = false;
    }
  }

  // --- Lägg till spel ---
  $("#addBetBtn").onclick = async ()=>{
    if(!currentProject) return alert("Välj/skapa projekt först.");
    const d = $("#iDate").value;
    const match = $("#iMatch").value.trim();
    const market = $("#iMarket").value.trim();
    const odds = parseFloat($("#iOdds").value);
    const stake = parseFloat($("#iStake").value);
    const book = $("#iBook").value.trim();
    const result = $("#iResult").value;

    if(!d || !match){
      alert("Ange matchdag och match.");
      return;
    }
    if(!Number.isFinite(odds) || odds <= 1){
      alert("Ange ett giltigt odds (större än 1.00).");
      return;
    }
    if(!Number.isFinite(stake) || stake <= 0){
      alert("Ange en giltig insats.");
      return;
    }

    const addBtn = $("#addBetBtn");
    if(!editingBetId && addBtn?.disabled){
      alert("Du har använt alla 20 gratis spel. Uppgradera för fler.");
      return;
    }

    const payload = {
      project_id: currentProject.id,
      user_id: currentUser.id,
      matchday: d,
      match,
      market: market || null,
      odds,
      stake,
      book: book || null,
      result
    };

    if(editingBetId){
      const { error } = await SB.from("bets")
        .update(payload)
        .eq("id", editingBetId)
        .eq("user_id", currentUser.id);
      if(error){ alert("Kunde inte uppdatera spel"); return; }
    }else{
      const { error } = await SB.from("bets").insert(payload);
      if(error){ alert("Kunde inte spara spel"); return; }
    }

    resetBetForm();
    await loadBets();
    setTab("list");
  };

  // --- Rendera lista (grupperad per månad) ---
  function renderBets(){
    const byMonth = {};
    for(const b of bets){
      if(!b.matchday) continue;
      const ym = b.matchday.slice(0,7); // YYYY-MM
      (byMonth[ym] ||= []).push(b);
    }
    const cont = $("#playsContainer");
    if(!cont) return;
    cont.innerHTML = "";

    if(!bets.length){
      cont.innerHTML = '<div class="empty-state">Inga spel registrerade ännu. Lägg till ditt första spel via formuläret till vänster.</div>';
      return;
    }

    const formatNumber = (value, decimals = 2) => {
      const num = Number(value);
      return Number.isFinite(num) ? num.toFixed(decimals) : "–";
    };
    const formatStake = value => {
      const num = Number(value);
      if(!Number.isFinite(num)) return "–";
      return Number.isInteger(num) ? num.toString() : num.toFixed(2);
    };

    Object.keys(byMonth).sort().reverse().forEach(ym=>{
      const arr = byMonth[ym];
      const [y,m] = ym.split("-").map(Number);
      const el = document.createElement("details");
      el.className = "month"; el.open = false;
      el.innerHTML = `<summary>${svMonth(y,m)}<span class="month-count">${arr.length} spel</span></summary>`;

      const header = document.createElement("div");
      header.className = "row row-head";
      header.innerHTML = `
        <div>Datum</div><div>Match &amp; Marknad</div><div>Odds</div>
        <div>Insats</div><div>Spelbolag</div><div>Status &amp; åtgärder</div>`;
      el.appendChild(header);

      for(const b of arr){
        const row = document.createElement("div"); row.className="row";
        const matchInfo = `${b.match || "–"}`;
        const marketInfo = b.market ? `<span class="market">${b.market}</span>` : "";
        const book = b.book ? b.book : "–";
        const status = b.result || "Pending";
        const statusClass = status.toLowerCase();
        const statusLabelMap = { Win: "Vinst", Loss: "Förlust", Pending: "Avvaktar", Void: "Void" };
        const statusLabel = statusLabelMap[status] || status;
        const fallbackId = Math.random().toString(36).slice(2, 9);
        const menuId = b.id ? `actions-${b.id}` : `actions-temp-${fallbackId}`;
        const resHtml = `
          <div class="result-cell">
            <span class="status-badge ${statusClass}">${statusLabel}</span>
            <div class="action-dropdown">
              <button type="button" class="dropdown-toggle" aria-haspopup="true" aria-expanded="false" aria-controls="${menuId}">Hantera</button>
              <div class="action-menu" id="${menuId}" role="menu">
                <button type="button" role="menuitem" data-action="status" data-value="Win">Markera som vinst</button>
                <button type="button" role="menuitem" data-action="status" data-value="Loss">Markera som förlust</button>
                <button type="button" role="menuitem" data-action="status" data-value="Pending">Markera som pending</button>
                <button type="button" role="menuitem" data-action="status" data-value="Void">Markera som void</button>
                <button type="button" role="menuitem" data-action="edit">Redigera</button>
                <button type="button" role="menuitem" data-action="delete">Ta bort</button>
              </div>
            </div>
          </div>`;
        row.innerHTML = `
          <div data-label="Datum">${b.matchday || "–"}</div>
          <div data-label="Match &amp; Marknad" class="cell-match"><span class="match">${matchInfo}</span>${marketInfo}</div>
          <div data-label="Odds">${formatNumber(b.odds, 2)}</div>
          <div data-label="Insats">${formatStake(b.stake)}</div>
          <div data-label="Spelbolag">${book}</div>
          <div data-label="Status &amp; åtgärder">${resHtml}</div>
        `;

        const dropdown = row.querySelector(".action-dropdown");
        if(dropdown){
          const toggle = dropdown.querySelector(".dropdown-toggle");
          const menu = dropdown.querySelector(".action-menu");
          if(toggle){
            toggle.addEventListener("click", ev => {
              ev.stopPropagation();
              const isOpen = dropdown.classList.contains("open");
              closeActionMenus();
              const willOpen = !isOpen;
              dropdown.classList.toggle("open", willOpen);
              toggle.setAttribute("aria-expanded", willOpen ? "true" : "false");
              if(willOpen && menu){
                const firstAction = menu.querySelector("[data-action]");
                if(firstAction){
                  firstAction.focus();
                }
              }
            });
          }
          if(menu){
            menu.addEventListener("click", ev => ev.stopPropagation());
            menu.querySelectorAll("[data-action]").forEach(btn => {
              btn.addEventListener("click", async ev => {
                ev.stopPropagation();
                const action = btn.dataset.action;
                if(action === "status"){
                  const value = btn.dataset.value;
                  const { error } = await SB.from("bets")
                    .update({ result: value })
                    .eq("id", b.id)
                    .eq("user_id", currentUser.id);
                  if(error){ alert("Kunde inte uppdatera resultat"); }
                  else await loadBets();
                }else if(action === "edit"){
                  startEdit(b);
                }else if(action === "delete"){
                  if(confirm("Ta bort spelet?")){
                    const { error } = await SB.from("bets")
                      .delete()
                      .eq("id", b.id)
                      .eq("user_id", currentUser.id);
                    if(error){ alert("Kunde inte ta bort spel"); }
                    else await loadBets();
                  }
                }
                closeActionMenus();
              });
            });
          }
        }
        el.appendChild(row);
      }
      cont.appendChild(el);
    });
  }

  function renderQuickStats(){
    const totalEl = $("#quickTotal");
    if(!totalEl) return;
    const total = bets.length;
    const pending = bets.filter(b => b.result === "Pending").length;
    const decided = bets.filter(b => b.result !== "Pending" && b.result !== "Void");
    const profit = bets.reduce((sum, b) => {
      const stakeNum = Number(b.stake);
      if(!Number.isFinite(stakeNum)) return sum;
      if(b.result === "Win"){
        const oddsNum = Number(b.odds);
        return Number.isFinite(oddsNum) ? sum + (oddsNum - 1) * stakeNum : sum;
      }
      if(b.result === "Loss"){
        return sum - stakeNum;
      }
      return sum;
    }, 0);
    const stakeSum = decided.reduce((sum,b)=>{
      const stakeNum = Number(b.stake);
      return Number.isFinite(stakeNum) ? sum + stakeNum : sum;
    },0);
    const roi = stakeSum > 0 ? (profit / stakeSum) * 100 : null;

    totalEl.textContent = total.toString();
    const pendingEl = $("#quickPending");
    if(pendingEl) pendingEl.textContent = pending.toString();
    const roiEl = $("#quickRoi");
    if(roiEl) roiEl.textContent = roi === null ? "–" : `${fmtMoney(roi)}%`;
    const profitEl = $("#quickProfit");
    if(profitEl) profitEl.textContent = fmtMoney(profit);
  }

  function recompute(monthFilter="all"){
    let data = bets;
    if(monthFilter!=="all"){
      data = data.filter(b => b.matchday?.startsWith(monthFilter));
    }
    const decided = data.filter(b => b.result!=="Pending" && b.result!=="Void");
    const wins = decided.filter(b => b.result==="Win").length;
    const stakeSum = decided.reduce((s,b)=>{
      const stakeNum = Number(b.stake);
      return Number.isFinite(stakeNum) ? s + stakeNum : s;
    },0);
    const profit = decided.reduce((s,b)=>{
      const stakeNum = Number(b.stake);
      if(!Number.isFinite(stakeNum)) return s;
      if(b.result==="Win"){
        const oddsNum = Number(b.odds);
        return Number.isFinite(oddsNum) ? s + (oddsNum-1)*stakeNum : s;
      }
      if(b.result==="Loss"){
        return s - stakeNum;
      }
      return s;
    }, 0);
    const roi = stakeSum>0 ? (profit/stakeSum)*100 : 0;

    $("#sGames").textContent = decided.length.toString();
    $("#sWins").textContent = wins.toString();
    $("#sProfit").textContent = fmtMoney(profit);
    $("#sRoi").textContent = fmtMoney(roi)+"%";

    if(monthFilter==="all"){ $("#sMonthName").textContent = "Alla månader"; }
    else{
      const [y,m] = monthFilter.split("-").map(Number);
      $("#sMonthName").textContent = svMonth(y,m);
    }
  }

  function renderSummary(){
    const months = [...new Set(bets.filter(b=>b.matchday).map(b=>b.matchday.slice(0,7)))].sort().reverse();
    const sel = $("#monthFilter");
    if(!sel) return;
    sel.innerHTML = `<option value="all">Alla månader</option>` + months.map(m=>`<option value="${m}">${m}</option>`).join("");
    sel.onchange = ()=>recompute(sel.value);
    recompute(sel.value||"all");
    renderQuickStats();
  }

  // --- Initiering ---
  (async function init(){
    try{
      await ensureAuth();
    }catch(err){
      console.warn("Användaren är inte inloggad", err);
      return;
    }

    resetBetForm();

    await loadProjects();
    if(!currentProject) await updateFreeBanner();
  })();
</script>
</body>
</html>
