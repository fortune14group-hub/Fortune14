<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>BetSpread – App</title>
  <script defer src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    body{background:#0b1324;color:#e6eefc;font-family:sans-serif;margin:0}
    header{background:#0d1528;padding:10px;display:flex;align-items:center;gap:10px}
    .btn{padding:6px 12px;border-radius:6px;border:1px solid #2a3955;background:#1f2937;color:#fff;cursor:pointer}
    .btn-green{background:#16a34a;border-color:#16a34a}
    .btn-red{background:#7f1d1d;border-color:#7f1d1d}
    .hidden{display:none}
    .container{padding:20px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #22314a;padding:6px;text-align:left}
    .quick button{margin-right:4px;padding:4px 6px;font-size:12px;border-radius:4px}
    .quick .win{background:#14532d;color:#fff;border:0}
    .quick .loss{background:#7f1d1d;color:#fff;border:0}
    .quick .pending{background:#1e3a8a;color:#fff;border:0}
    .quick .void{background:#374151;color:#fff;border:0}
  </style>
</head>
<body>
<header>
  <span id="userEmail"></span>
  <button id="upgradeBtn" class="btn btn-green">Uppgradera</button>
  <button id="manageBillingBtn" class="btn hidden">Hantera betalning</button>
  <button id="logoutBtn" class="btn">Logga ut</button>
</header>

<main class="container">
  <h2>Dina projekt</h2>
  <select id="projectSelect"></select>
  <button id="newProjectBtn" class="btn">Nytt projekt</button>
  <button id="deleteProjectBtn" class="btn btn-red">Ta bort projekt</button>

  <h2>Registrera spel</h2>
  <input type="date" id="dateInput">
  <input type="text" id="matchInput" placeholder="Match">
  <input type="text" id="marketInput" placeholder="Marknad">
  <input type="number" id="oddsInput" placeholder="Odds" step="0.01">
  <input type="number" id="stakeInput" placeholder="Insats" value="1" step="0.01">
  <button id="addBetBtn" class="btn btn-green">Lägg till</button>
  <div id="freeBanner" class="hidden">Gratisläge: <b id="usedCount">0</b>/20 spel använda</div>

  <h2>Summering per månad</h2>
  <table>
    <thead><tr><th>Månad</th><th>Spel</th><th>Wins</th><th>Loss</th><th>Insats</th><th>Profit</th><th>ROI</th></tr></thead>
    <tbody id="summaryTable"></tbody>
  </table>

  <h2>Spel</h2>
  <table>
    <thead><tr><th>Datum</th><th>Match</th><th>Marknad</th><th>Odds</th><th>Insats</th><th>Resultat</th><th>Snabb</th><th></th></tr></thead>
    <tbody id="betsTable"></tbody>
  </table>
</main>

<script>
const supabase = window.supabase.createClient(
  "https://updpywjfxeahtjpelbku.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVwZHB5d2pmeGVhaHRqcGVsYmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MjQzOTcsImV4cCI6MjA3MjUwMDM5N30.i1ztG8dkcHFLq8WEn_uVrgCBk0_Wf5gZb_OQQuaSGgo"
);

let user=null, currentProject=null, isPremium=false;

document.addEventListener("DOMContentLoaded", async () => {
  const { data:{ session } } = await supabase.auth.getSession();
  if(!session){ location.href="login.html"; return; }
  user=session.user;
  document.getElementById("userEmail").textContent=user.email;

  await loadUser();
  await loadProjects();

  document.getElementById("newProjectBtn").onclick=createProject;
  document.getElementById("deleteProjectBtn").onclick=deleteProject;
  document.getElementById("addBetBtn").onclick=addBet;
  document.getElementById("logoutBtn").onclick=logout;
  document.getElementById("upgradeBtn").onclick=upgrade;
  document.getElementById("manageBillingBtn").onclick=manageBilling;
});

async function loadUser(){
  const { data } = await supabase.from("users").select("is_premium").eq("id",user.id).single();
  if(data) isPremium=data.is_premium;
  if(!isPremium) document.getElementById("freeBanner").classList.remove("hidden");
  else {
    document.getElementById("upgradeBtn").classList.add("hidden");
    document.getElementById("manageBillingBtn").classList.remove("hidden");
  }
}

async function loadProjects(){
  const { data } = await supabase.from("projects").select("id,name").eq("user_id",user.id);
  const sel=document.getElementById("projectSelect");
  sel.innerHTML="";
  data.forEach(p=>{
    const opt=document.createElement("option"); opt.value=p.id; opt.textContent=p.name; sel.appendChild(opt);
  });
  if(data.length){ currentProject=data[0].id; sel.value=currentProject; await loadBets(); }
  sel.onchange=()=>{ currentProject=sel.value; loadBets(); }
}

async function createProject(){
  const name=prompt("Projektets namn:","Nytt projekt"); if(!name) return;
  await supabase.from("projects").insert({user_id:user.id,name});
  await loadProjects();
}

async function deleteProject(){
  if(!currentProject) return;
  if(!confirm("Radera projektet och alla spel?")) return;
  await supabase.from("bets").delete().eq("project_id",currentProject);
  await supabase.from("projects").delete().eq("id",currentProject);
  await loadProjects();
}

async function addBet(){
  if(!currentProject) return alert("Skapa ett projekt först!");
  if(!isPremium){
    const { count } = await supabase.from("bets").select("*",{count:"exact",head:true}).eq("user_id",user.id);
    if(count>=20){ alert("Gratisgräns 20 spel. Uppgradera för obegränsat!"); return; }
    document.getElementById("usedCount").textContent=count+1;
  }
  const bet={
    user_id:user.id, project_id:currentProject,
    matchday:document.getElementById("dateInput").value,
    match:document.getElementById("matchInput").value,
    market:document.getElementById("marketInput").value,
    odds:parseFloat(document.getElementById("oddsInput").value),
    stake:parseFloat(document.getElementById("stakeInput").value),
    result:"Pending"
  };
  await supabase.from("bets").insert(bet);
  await loadBets();
}

async function loadBets(){
  if(!currentProject) return;
  const { data } = await supabase.from("bets").select("*").eq("project_id",currentProject).order("matchday",{ascending:false});
  const tbody=document.getElementById("betsTable"); tbody.innerHTML="";
  data.forEach(b=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${b.matchday}</td>
      <td>${b.match}</td>
      <td>${b.market}</td>
      <td>${b.odds}</td>
      <td>${b.stake}</td>
      <td>${b.result}</td>
      <td class="quick">
        <button class="win" onclick="updateResult('${b.id}','Win')">Win</button>
        <button class="loss" onclick="updateResult('${b.id}','Loss')">Loss</button>
        <button class="pending" onclick="updateResult('${b.id}','Pending')">Pending</button>
        <button class="void" onclick="updateResult('${b.id}','Void')">Void</button>
      </td>
      <td><button class="btn btn-red" onclick="deleteBet('${b.id}')">X</button></td>`;
    tbody.appendChild(tr);
  });
  renderSummary(data);
}

function renderSummary(data){
  const groups={};
  data.forEach(b=>{
    const ym=b.matchday.slice(0,7);
    (groups[ym] ||= []).push(b);
  });
  const tbody=document.getElementById("summaryTable"); tbody.innerHTML="";
  Object.entries(groups).forEach(([ym,list])=>{
    const settled=list.filter(b=>b.result!=="Pending");
    const stake=settled.reduce((s,b)=>s+(b.result==="Void"?0:b.stake),0);
    const profit=settled.reduce((p,b)=>{
      if(b.result==="Win") return p+(b.odds*b.stake-b.stake);
      if(b.result==="Loss") return p-b.stake;
      return p;
    },0);
    const w=settled.filter(b=>b.result==="Win").length;
    const l=settled.filter(b=>b.result==="Loss").length;
    const roi=stake>0?(profit/stake*100):0;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${ym}</td><td>${list.length}</td><td>${w}</td><td>${l}</td><td>${stake}</td><td>${profit.toFixed(2)}</td><td>${roi.toFixed(1)}%</td>`;
    tbody.appendChild(tr);
  });
}

async function updateResult(id,val){
  await supabase.from("bets").update({result:val}).eq("id",id);
  await loadBets();
}
async function deleteBet(id){
  await supabase.from("bets").delete().eq("id",id);
  await loadBets();
}

async function logout(){
  await supabase.auth.signOut();
  location.href="index.html";
}

async function upgrade(){
  const res=await fetch("/api/create-checkout-session",{method:"POST"});
  const d=await res.json(); if(d.url) location.href=d.url;
}
async function manageBilling(){
  const res=await fetch("/api/create-portal-session",{method:"POST"});
  const d=await res.json(); if(d.url) location.href=d.url;
}
</script>
</body>
</html>
