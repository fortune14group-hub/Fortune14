<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>BetSpread – Projekt & Flikar</title>
<style>
  :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
  body { margin:24px; background:#0b1116; color:#e7eef5; }
  h1 { margin:0 0 12px; font-size:20px; }
  .topbar{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:12px}
  .projbox{display:flex;gap:8px;align-items:center}
  select,input,button{padding:10px;border-radius:8px;border:1px solid #243244;background:#0b1320;color:#e7eef5}
  button{cursor:pointer}
  .btn{background:#22c55e;color:#0b1116;border:0;font-weight:600}
  .btn-outline{background:transparent;border:1px solid #334155}
  .tabs{display:flex;gap:6px;margin:12px 0}
  .tab{padding:8px 12px;border:1px solid #334155;border-bottom:0;border-radius:8px 8px 0 0;background:#0f1720;cursor:pointer}
  .tab.active{background:#17212e;font-weight:700}
  .card{background:#0f1720;border:1px solid #1f2a37;border-radius:12px;padding:16px;margin-bottom:16px}
  .grid{display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:12px}
  .grid-4{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:12px}
  label{font-size:12px;color:#b6c2cf;display:block;margin-bottom:6px}
  table{width:100%;border-collapse:collapse}
  th,td{border-bottom:1px solid #1f2a37;padding:10px;text-align:left;font-size:14px}
  th{color:#b6c2cf;font-weight:600}
  .right{text-align:right}
  .summary{display:flex;flex-wrap:wrap;gap:12px}
  .pill{background:#0b1320;border:1px solid #1f2a37;padding:10px 12px;border-radius:10px;min-width:140px}
  .muted{color:#93a4b4}
  .tag{padding:4px 8px;border-radius:999px;font-size:12px;display:inline-block}
  .tag-win{background:#083d24;color:#22c55e}
  .tag-loss{background:#3b0a0a;color:#f87171}
  .tag-pending{background:#17324a;color:#60a5fa}
  .tag-void{background:#2f2f2f;color:#cbd5e1}
  .row-actions{display:flex;gap:6px}
  @media (max-width:1200px){ .grid{grid-template-columns:repeat(3,1fr)} }
  @media (max-width:700px){ .grid{grid-template-columns:repeat(2,1fr)} .grid-4{grid-template-columns:repeat(2,1fr)} }
</style>
</head>
<body>
  <div class="topbar">
    <h1>BetSpread</h1>
    <div class="projbox">
      <label for="projectSelect" style="margin:0">Projekt:</label>
      <select id="projectSelect"></select>
      <button class="btn" id="newProjectBtn">Nytt projekt</button>
      <button class="btn-outline" id="renameProjectBtn">Byt namn</button>
      <button class="btn-outline" id="deleteProjectBtn">Radera</button>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="register">Registrera spel</div>
    <div class="tab" data-tab="summary">Månadssummering</div>
    <div class="tab" data-tab="list">Spel</div>
  </div>

  <!-- REGISTRERA -->
  <section id="tab-register" class="card">
    <div class="grid">
      <div>
        <label>Utskick (datum)</label>
        <input type="date" id="sentDate">
      </div>
      <div>
        <label>Matchdag</label>
        <input type="date" id="matchDate">
      </div>
      <div>
        <label>Match</label>
        <input type="text" id="match" placeholder="Arsenal – Chelsea">
      </div>
      <div>
        <label>Marknad</label>
        <input type="text" id="market" placeholder="Över 8.5 frisparkar">
      </div>
      <div>
        <label>Oddset</label>
        <input type="number" step="0.01" id="odds" placeholder="1.85">
      </div>
      <div>
        <label>Insats</label>
        <input type="number" step="0.01" id="stake" placeholder="200">
      </div>
    </div>

    <div class="grid-4" style="margin-top:12px">
      <div>
        <label>Spelbolag</label>
        <input type="text" id="bookie" placeholder="Bet365">
      </div>
      <div>
        <label>Resultat</label>
        <select id="result">
          <option value="PENDING">Pending</option>
          <option value="WIN">Vinst</option>
          <option value="LOSS">Förlust</option>
          <option value="VOID">Void</option>
        </select>
      </div>
      <div>
        <label>Notering</label>
        <input type="text" id="note" placeholder="Ex. sent mål, cashout, etc.">
      </div>
      <div>
        <label>&nbsp;</label>
        <button class="btn" id="addBtn">Lägg till spel</button>
      </div>
    </div>
    <div style="margin-top:8px">
      <button class="btn-outline" id="clearBtn" title="Raderar allt i detta projekt">Nollställ projekt</button>
    </div>
  </section>

  <!-- SUMMERING -->
  <section id="tab-summary" class="card" style="display:none">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div style="display:flex;gap:12px;align-items:center">
        <div>
          <label>Månad (matchdag)</label>
          <select id="monthFilterSummary"></select>
        </div>
      </div>
      <div class="summary" id="summaryBoxes"></div>
    </div>
    <div style="margin-top:12px">
      <table id="summaryTable">
        <thead>
          <tr>
            <th>Månad</th>
            <th class="right">Spel (avgjorda)</th>
            <th class="right">Win</th>
            <th class="right">Loss</th>
            <th class="right">Pending</th>
            <th class="right">Total insats</th>
            <th class="right">Profit</th>
            <th class="right">ROI</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <p class="muted" style="margin-top:8px">Månadsnamn visas på svenska och bygger på matchdag.</p>
    </div>
  </section>

  <!-- LISTA -->
  <section id="tab-list" class="card" style="display:none">
    <div style="display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap">
      <div style="display:flex;gap:12px;align-items:center">
        <div>
          <label>Månad (matchdag)</label>
          <select id="monthFilterList"></select>
        </div>
        <div>
          <label>Sök</label>
          <input type="text" id="search" placeholder="Match/marknad/spelbolag...">
        </div>
      </div>
      <div class="summary" id="listSummary"></div>
    </div>

    <div style="margin-top:12px">
      <table id="betsTable">
        <thead>
          <tr>
            <th>Utskick</th>
            <th>Matchdag</th>
            <th>Match</th>
            <th>Marknad</th>
            <th>Spelbolag</th>
            <th class="right">Odds</th>
            <th class="right">Insats</th>
            <th>Status</th>
            <th class="right">Utbetalning</th>
            <th class="right">Profit</th>
            <th class="right">ROI</th>
            <th>Åtg.</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

<script>
(function(){
  /* ---------- Constants ---------- */
  const STORE_PROJECTS = "betspread-projects-v1";
  const STORE_CURRENT  = "betspread-current-project-v1";
  const DATA_PREFIX    = "betspread-data-";
  const MONTHS_SV = ["januari","februari","mars","april","maj","juni","juli","augusti","september","oktober","november","december"];

  /* ---------- Elements ---------- */
  const el = (id)=>document.getElementById(id);
  const tabs = document.querySelectorAll('.tab');
  const sections = {
    register: document.getElementById('tab-register'),
    summary:  document.getElementById('tab-summary'),
    list:     document.getElementById('tab-list'),
  };
  const projSelect = el('projectSelect');

  const form = {
    sentDate: el('sentDate'),
    matchDate: el('matchDate'),
    match: el('match'),
    market: el('market'),
    odds: el('odds'),
    stake: el('stake'),
    bookie: el('bookie'),
    result: el('result'),
    note: el('note'),
    addBtn: el('addBtn'),
    clearBtn: el('clearBtn'),
  };

  const listUI = {
    monthFilter: el('monthFilterList'),
    search: el('search'),
    tableBody: document.querySelector('#betsTable tbody'),
    summary: el('listSummary'),
  };

  const sumUI = {
    monthFilter: el('monthFilterSummary'),
    boxes: el('summaryBoxes'),
    tableBody: document.querySelector('#summaryTable tbody'),
  };

  /* ---------- Projects ---------- */
  let projects = loadProjects();
  if (projects.length === 0) {
    const p = createProject("Bet365");
    projects.push(p);
    saveProjects(projects);
    setCurrentProjectId(p.id);
  }
  let currentProjectId = getCurrentProjectId() || projects[0].id;

  function createProject(name){
    return { id: crypto.randomUUID(), name: name || "Projekt" };
  }
  function loadProjects(){ try { return JSON.parse(localStorage.getItem(STORE_PROJECTS))||[] } catch { return [] } }
  function saveProjects(arr){ localStorage.setItem(STORE_PROJECTS, JSON.stringify(arr)); }
  function getCurrentProjectId(){ return localStorage.getItem(STORE_CURRENT); }
  function setCurrentProjectId(id){ localStorage.setItem(STORE_CURRENT, id); currentProjectId=id; }

  function refreshProjectSelect(){
    projSelect.innerHTML = projects.map(p=>`<option value="${p.id}" ${p.id===currentProjectId?'selected':''}>${p.name}</option>`).join('');
  }

  /* ---------- Data (per project) ---------- */
  function dataKey(){ return DATA_PREFIX + currentProjectId; }
  function loadBets(){
    try { return migrate(JSON.parse(localStorage.getItem(dataKey()))||[]); }
    catch { return []; }
  }
  function saveBets(bets){ localStorage.setItem(dataKey(), JSON.stringify(bets)); }
  function clearBets(){ localStorage.setItem(dataKey(), JSON.stringify([])); }

  function migrate(arr){
    // Back-compat: if only "date" exists, copy to both dates
    return (arr||[]).map(b=>{
      if(!b.sent_date && b.date) b.sent_date=b.date;
      if(!b.match_date && b.date) b.match_date=b.date;
      return b;
    });
  }

  /* ---------- Helpers ---------- */
  function formatMoney(n){ return (Number(n)||0).toFixed(2); }
  function payout(b){ if(b.result==='WIN') return b.stake*b.odds; if(b.result==='VOID') return b.stake; return 0; }
  function profit(b){ if(b.result==='WIN') return b.stake*(b.odds-1); if(b.result==='LOSS') return -b.stake; return 0; }
  function tag(status){
    const m={WIN:'tag-win',LOSS:'tag-loss',PENDING:'tag-pending',VOID:'tag-void'};
    const l={WIN:'Vinst',LOSS:'Förlust',PENDING:'Pending',VOID:'Void'}[status]||status;
    return `<span class="tag ${m[status]||'tag-pending'}">${l}</span>`;
  }
  function yyyymm(d){ const dt=new Date(d); if(isNaN(dt)) return ''; return dt.getFullYear()+"-"+String(dt.getMonth()+1).padStart(2,'0'); }
  function monthIdx(d){ const dt=new Date(d); return isNaN(dt)?null:(dt.getMonth()+1); } // 1..12
  function monthName(idx){ return MONTHS_SV[(idx-1+12)%12]; }
  function monthNameWithYear(d){ const dt=new Date(d); if(isNaN(dt)) return ''; return `${MONTHS_SV[dt.getMonth()]} ${dt.getFullYear()}`; }

  /* ---------- Tabs ---------- */
  tabs.forEach(t=>{
    t.addEventListener('click', ()=>{
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      Object.values(sections).forEach(s=>s.style.display='none');
      sections[t.dataset.tab].style.display='block';
    });
  });

  /* ---------- Project buttons ---------- */
  document.getElementById('newProjectBtn').addEventListener('click', ()=>{
    const name = prompt("Namn på nytt projekt:", "Nytt projekt");
    if(!name) return;
    const p = createProject(name.trim());
    projects.push(p); saveProjects(projects); setCurrentProjectId(p.id); refreshProjectSelect(); renderAll();
  });

  document.getElementById('renameProjectBtn').addEventListener('click', ()=>{
    const p = projects.find(x=>x.id===currentProjectId); if(!p) return;
    const name = prompt("Nytt namn:", p.name);
    if(!name) return;
    p.name = name.trim(); saveProjects(projects); refreshProjectSelect();
  });

  document.getElementById('deleteProjectBtn').addEventListener('click', ()=>{
    if(projects.length<=1){ alert("Du måste ha minst ett projekt."); return; }
    const p = projects.find(x=>x.id===currentProjectId);
    if(!confirm(`Radera projekt "${p.name}" och alla dess spel?`)) return;
    // remove data
    localStorage.removeItem(DATA_PREFIX + currentProjectId);
    // remove project
    projects = projects.filter(x=>x.id!==currentProjectId);
    saveProjects(projects);
    setCurrentProjectId(projects[0].id);
    refreshProjectSelect(); renderAll();
  });

  projSelect.addEventListener('change', ()=>{
    setCurrentProjectId(projSelect.value);
    renderAll();
  });

  /* ---------- Register actions ---------- */
  form.addBtn.addEventListener('click', ()=>{
    const bet = {
      id: crypto.randomUUID(),
      sent_date: form.sentDate.value || new Date().toISOString().slice(0,10),
      match_date: form.matchDate.value || form.sentDate.value || new Date().toISOString().slice(0,10),
      match: form.match.value.trim(),
      market: form.market.value.trim(),
      odds: Number(form.odds.value),
      stake: Number(form.stake.value),
      bookie: form.bookie.value.trim(),
      result: form.result.value,
      note: form.note.value.trim(),
    };
    if(!bet.match || !bet.market || !bet.odds || !bet.stake){ alert("Fyll i minst Match, Marknad, Odds och Insats."); return; }
    const bets = loadBets(); bets.unshift(bet); saveBets(bets); renderAll();
    form.match.value=form.market.value=form.note.value=''; form.odds.value=''; form.stake.value=''; form.result.value='PENDING';
  });

  form.clearBtn.addEventListener('click', ()=>{
    if(!confirm("Detta raderar ALLA spel i detta projekt. Fortsätt?")) return;
    clearBets(); renderAll();
  });

  /* ---------- List filters ---------- */
  listUI.monthFilter.addEventListener('change', renderList);
  listUI.search.addEventListener('input', renderList);

  /* ---------- Summary filters ---------- */
  sumUI.monthFilter.addEventListener('change', renderSummary);

  /* ---------- Renderers ---------- */
  function renderMonthFilters(){
    const bets = loadBets();
    const months = new Set(bets.map(b=>yyyymm(b.match_date)).filter(Boolean));
    const sorted = Array.from(months).sort().reverse();
    const optList = [`<option value="ALL">Alla månader</option>`]
      .concat(sorted.map(k=>{
        // k = "YYYY-MM"
        const year=k.slice(0,4), m=parseInt(k.slice(5),10);
        return `<option value="${k}">${MONTHS_SV[m-1]} ${year}</option>`;
      })).join('');
    listUI.monthFilter.innerHTML = optList;
    sumUI.monthFilter.innerHTML  = optList;
  }

  function renderList(){
    const bets = loadBets();
    const k = listUI.monthFilter.value || 'ALL';
    const q = (listUI.search.value||'').toLowerCase();

    const filtered = bets.filter(b=>{
      const okMonth = k==='ALL' || yyyymm(b.match_date)===k;
      const hay = [b.match,b.market,b.bookie,b.note].join(' ').toLowerCase();
      const okQ = !q || hay.includes(q);
      return okMonth && okQ;
    });

    listUI.tableBody.innerHTML = filtered.map(b=>{
      const pay=payout(b), prof=profit(b);
      const roi = (b.result==='WIN'||b.result==='LOSS') && b.stake>0 ? (prof/b.stake)*100 : 0;
      return `<tr>
        <td>${b.sent_date||''}</td>
        <td>${b.match_date||''}</td>
        <td>${b.match||''}</td>
        <td>${b.market||''}</td>
        <td>${b.bookie||''}</td>
        <td class="right">${formatMoney(b.odds)}</td>
        <td class="right">${formatMoney(b.stake)}</td>
        <td>${tag(b.result)}</td>
        <td class="right">${formatMoney(pay)}</td>
        <td class="right">${formatMoney(prof)}</td>
        <td class="right">${(b.result==='WIN'||b.result==='LOSS')?formatMoney(roi)+'%':'—'}</td>
        <td class="row-actions">
          <button class="btn-outline" onclick="editBet('${b.id}')">Ändra</button>
          <button class="btn-outline" onclick="deleteBet('${b.id}')">Ta bort</button>
        </td>
      </tr>`;
    }).join('');

    // list summary (avgjorda)
    const settled = filtered.filter(b=>b.result!=='PENDING');
    const totalStake = settled.reduce((s,b)=>s + (b.stake||0), 0);
    const totalProfit = settled.reduce((s,b)=>s + profit(b), 0);
    const wins = settled.filter(b=>b.result==='WIN').length;
    const losses = settled.filter(b=>b.result==='LOSS').length;
    const roi = totalStake>0 ? (totalProfit/totalStake)*100 : 0;
    listUI.summary.innerHTML = `
      <div class="pill"><div class="muted">Spel (avgjorda)</div><div><strong>${settled.length}</strong> (Win ${wins} / Loss ${losses})</div></div>
      <div class="pill"><div class="muted">Pending</div><div><strong>${filtered.filter(b=>b.result==='PENDING').length}</strong></div></div>
      <div class="pill"><div class="muted">Total insats</div><div><strong>${formatMoney(totalStake)}</strong></div></div>
      <div class="pill"><div class="muted">Profit</div><div><strong>${formatMoney(totalProfit)}</strong></div></div>
      <div class="pill"><div class="muted">ROI</div><div><strong>${formatMoney(roi)}%</strong></div></div>
    `;
  }

  function renderSummary(){
    const bets = loadBets();
    const k = sumUI.monthFilter.value || 'ALL';

    // group by yyyymm
    const groups = {};
    for(const b of bets){
      const key = yyyymm(b.match_date);
      if(!key) continue;
      if(!groups[key]) groups[key]=[];
      groups[key].push(b);
    }
    const keys = Object.keys(groups).sort().reverse(); // latest first

    const rows = [];
    for(const key of keys){
      if(k!=='ALL' && key!==k) continue;
      const arr = groups[key];
      const settled = arr.filter(x=>x.result!=='PENDING');
      const wins = arr.filter(x=>x.result==='WIN').length;
      const losses = arr.filter(x=>x.result==='LOSS').length;
      const pend = arr.filter(x=>x.result==='PENDING').length;
      const totalStake = settled.reduce((s,x)=>s+(x.stake||0),0);
      const totalProfit = settled.reduce((s,x)=>s+profit(x),0);
      const roi = totalStake>0 ? (totalProfit/totalStake)*100 : 0;

      const display = monthNameWithYear(key+"-01");
      rows.push(`
        <tr>
          <td>${display}</td>
          <td class="right">${settled.length}</td>
          <td class="right">${wins}</td>
          <td class="right">${losses}</td>
          <td class="right">${pend}</td>
          <td class="right">${formatMoney(totalStake)}</td>
          <td class="right">${formatMoney(totalProfit)}</td>
          <td class="right">${formatMoney(roi)}%</td>
        </tr>
      `);
    }
    sumUI.tableBody.innerHTML = rows.join('') || `<tr><td colspan="8" class="muted">Inga data ännu.</td></tr>`;

    // header summary (overall of filtered)
    const filteredAll = (k==='ALL') ? bets : bets.filter(b=>yyyymm(b.match_date)===k);
    const settled = filteredAll.filter(b=>b.result!=='PENDING');
    const totalStake = settled.reduce((s,b)=>s+(b.stake||0),0);
    const totalProfit = settled.reduce((s,b)=>s+profit(b),0);
    const wins = settled.filter(b=>b.result==='WIN').length;
    const losses = settled.filter(b=>b.result==='LOSS').length;
    const roi = totalStake>0 ? (totalProfit/totalStake)*100 : 0;
    sumUI.boxes.innerHTML = `
      <div class="pill"><div class="muted">Spel (avgjorda)</div><div><strong>${settled.length}</strong> (Win ${wins} / Loss ${losses})</div></div>
      <div class="pill"><div class="muted">Pending</div><div><strong>${filteredAll.filter(b=>b.result==='PENDING').length}</strong></div></div>
      <div class="pill"><div class="muted">Total insats</div><div><strong>${formatMoney(totalStake)}</strong></div></div>
      <div class="pill"><div class="muted">Profit</div><div><strong>${formatMoney(totalProfit)}</strong></div></div>
      <div class="pill"><div class="muted">ROI</div><div><strong>${formatMoney(roi)}%</strong></div></div>
    `;
  }

  function renderMonthFiltersAndAll(){
    renderMonthFilters();
    renderList();
    renderSummary();
  }

  function renderAll(){
    refreshProjectSelect();
    setDefaultDates();
    renderMonthFiltersAndAll();
  }

  /* ---------- Global actions for edit/delete ---------- */
  window.deleteBet = function(id){
    if(!confirm('Ta bort raden?')) return;
    const bets = loadBets().filter(b=>b.id!==id);
    saveBets(bets); renderMonthFiltersAndAll();
  };

  window.editBet = function(id){
    const bets = loadBets();
    const b = bets.find(x=>x.id===id); if(!b) return;
    // förifyll
    form.sentDate.value = b.sent_date || '';
    form.matchDate.value = b.match_date || '';
    form.match.value = b.match || '';
    form.market.value = b.market || '';
    form.odds.value = b.odds || '';
    form.stake.value = b.stake || '';
    form.bookie.value = b.bookie || '';
    form.result.value = b.result || 'PENDING';
    form.note.value = b.note || '';
    // ta bort den gamla; ny sparas när du trycker "Lägg till spel"
    const rest = bets.filter(x=>x.id!==id);
    saveBets(rest); renderMonthFiltersAndAll();
    // hoppa till fliken Registrera
    document.querySelector('.tab[data-tab="register"]').click();
  };

  /* ---------- Init ---------- */
  function setDefaultDates(){
    const today = new Date().toISOString().slice(0,10);
    if(!form.sentDate.value) form.sentDate.value = today;
    if(!form.matchDate.value) form.matchDate.value = today;
  }

  refreshProjectSelect();
  setDefaultDates();
  renderMonthFiltersAndAll();
})();
</script>
</body>
</html>
